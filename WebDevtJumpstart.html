<!DOCTYPE html>
<html>
<head>
<title>Web Development Jumpstart</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<link rel="stylesheet" type="text/css" href="css/basic.css" />
<link rel="stylesheet" href="css/bootstrap-combined.css"/>

    <script src="lib/jquery.js"></script>
    <script src="lib/bootstrap.js"></script>


<style type="text/css">
/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54365763-1', 'auto');
  ga('send', 'pageview');

</script>

</head>
<body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar">
            <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
          </button>
          
          <div>
            <ul class="nav">
              <li>
                <a href="http://itjumpstart.wordpress.com" target="_blank"><p>ITJUMPSTART</p></a>
              </li>

            </ul>
          </div>
          <!--/.nav-collapse -->
        </div>
      </div>
    </div>

	
<br><br>


<h1>Web Development Jumpstart</h1>

<p><strong>Author</strong>: Isagani Mendoza (ITJUMPSTART.WORDPRESS.COM)</p>

<p><strong>Preface</strong></p>

<p>Web application development is a broad subject. As such, this book makes a few assumptions and only covers core technologies that are fundamental to everyday usage by solo developers and small/medium-sized businesses. My perspectives about Web application development are laid out in my free pdf guidebook <strong>"Web Development Fundamentals"</strong> at <a href="http://itjumpstart.wordpress.com">ITJUMPSTART</a>.  I require that you read that guidebook so that we are on the same page. I do not expect you to agree with all my viewpoints but then, it is up to you if you want to learn those lessons the hard way.</p>

<p>The rules distilled in that guidebook are not my sole observations but hard-earned experience from authors, bloggers and practitioners in the software industry. However, I do not speak for themselves so if I quote them, it must be taken in its proper context. I am certain to ruffle some feathers but that is normal in an industry rife with dogmas and subjectivity. Haters gonna hate.</p>

<p>Instead, I want you to get the basics right. I want you to free your mind from marketing hype. I want you to challenge the prevailing <a href="http://www.drdobbs.com/architecture-and-design/interview-with-alan-kay/240003442">pop culture</a> and see for yourself where it will stand years from now. Technologies come and go not because they go out of fashion but because they crumble out of complexity.</p>

<p>The same goes with Web development. The Web is a platform and always will be. Alan Kay said that the Web was done by amateurs. But I bet you are not one of <a href="http://blog.codinghorror.com/a-visit-with-alan-kay">those</a>.</p>

<p><strong>Acknowledgment</strong></p>

<p>Thanks to all developers of open source projects without whom this book would have been non-existent</p>

<p><strong>Copyright</strong></p>

<p>All rights reserved. No part of this book may be reproduced without written consent from me. Portions taken from the documentation of open source software used in this book are covered by its respective license.</p>

<p><strong>Intended Audience</strong></p>

<ul class="task-list">
<li>You are a <a href="https://al3x.net/2010/07/27/node.html">small-scale</a> developer</li>
<li>Your target deployment is a couple of servers or even VPS</li>
<li>You need to build Web apps, not media sites or mobile apps</li>
<li>You just need plain old relational database, not NoSQL</li>
<li>You want a turnkey Web app example, not piecemeal solution</li>
<li>You are one or more of the above</li>
</ul><p><br></p>

<h2>Part I. Overview</h2>

<blockquote>
<p>Code first, refactor later</p>
</blockquote>

<p>My approach to programming is to start small. You need to code the functionality aspect first. Once your code gets big and messy, that's the time you need to refactor your code. As the saying goes, premature optimization is the root of all evil.</p>

<blockquote>
<p>Code first, automate later</p>
</blockquote>

<p>Once you get the hang of programming, you may automate those tedious testing processes. However, testing automation is beyond the scope of this book. I want you to concentrate on the basics first. Those automation techniques can be learned later. The first order of the day is to get past the functionality stage. In common language, get your house in order first.</p>

<p>To paraphrase <a href="http://blog.gigaspaces.com/an-application-centric-approach-to-devops-2/">Matt Jaynes</a> of DevOps University:</p>

<p>"You should get your house in order before aspiring to do automation or CD (continuous deployment)."</p>

<h3>What is FUSS Programming?</h3>

<ul class="task-list">
<li>F - Functionality (Is the program working?)</li>
<li>U - Usability (Is the program easy to use?)</li>
<li>S - Speed (Is the program fast?)</li>
<li>S - Security (Is the program secure?)</li>
</ul><p>The first three criteria are enshrined in the famous saying:</p>

<blockquote>
<p>Make it work, make it right, make it fast</p>
</blockquote>

<p>The same is true for programming Web applications. Other considerations like program modularity and extensibility are left to the developer as you gain experience.</p>

<p>Of course, those three criteria are nothing if your application is not secure. So to round out the saying:</p>

<blockquote>
<p>Make it work, make it right, make it fast, make it secure</p>
</blockquote>

<ol class="task-list">
<li><p>Functionality is about coding now, refactor later. You want your program to be working first. In other words, your concern is to get the job done.</p></li>
<li><p>Usability is about the user experience otherwise known as "Don't make me think" principle. If functionality is about getting the job done, usability is about getting it done right.</p></li>
<li><p>Speed is about quantity in terms of minimal parts needed to achieve the same functionality and usability. Speed is not about what features to add but about what features to remove, such that your application is not bloated. You need to ask yourself if a certain feature is necessary or not. If not, chop it off without hesitation. If you have <a href="http://en.wikipedia.org/wiki/Occam%27s_razor">less moving parts</a>, you get minimal performance drag. Of course, speed is also brought about by a sound architecture which depends on your software choice.</p></li>
<li><p>Security is about processes, not off-the-shelf "security" products.</p></li>
</ol><p><strong>Development Stack</strong></p>

<ul class="task-list">
<li>Turnkey Linux</li>
<li>nginx</li>
<li>Node</li>
<li>MySQL</li>
<li>JavaScript editor</li>
<li>VirtualBox</li>
</ul><blockquote>
<p>Why Turnkey Linux?</p>
</blockquote>

<p>Turnkey Linux is a Debian-based OS that includes Web Shell which is a Web interface to the command line and WebMin which acts as a control panel.</p>

<p>Web Shell is based on the concept of <a href="http://en.wikipedia.org/wiki/Web-based_SSH">Web-based SSH</a> which basically means that you can access your server's command line using only a Web browser (without using a third-party SSH client). Turnkey Linux does this by using <a href="https://code.google.com/p/shellinabox/">Shell in a Box</a> (SIAB). In turn, <a href="http://www.linux-mag.com/id/7864/">SIAB</a> does this by implementing a Web server that can export arbitrary command line tools to a web based terminal emulator. This emulator is accessible to any Web browser and does not require any additional browser plugins.</p>

<p>In simple diagram,</p>

<p>Turnkey Linux server (via SSH) --- SIAB SSH client --- SIAB Web server --- Your Web browser (via terminal emulator client called vt100.js) </p>

<p>That means, you can download a Turnkey Linux image and run it as a virtual machine on your laptop, and it will be identical when deployed to production, assuming of course that you have taken note of your application settings and its dependencies. With configuration management tool like Ansible, the disparity between Devs and Ops environment is becoming minimal.</p>

<blockquote>
<p>Why nginx?</p>
</blockquote>

<p>Read the <a href="http://12factor.net/">Twelve Factor App</a> manifesto. In essence, nginx as a Web server and reverse proxy enables you to decouple your applications from a Web server. That means your Web app is an external process outside of the Web server so it does not bring down the latter if the former crashes. Second, nginx uses an asynchronous architecture in the way it handles Web requests which is more efficient than Apache. And third, nginx enables you to serve static files directly while it delegates dynamic requests to your Web apps. This kind of setup enables you to scale out your Web tier, meaning you can clone as many nginx servers as you need together with your Web apps to handle the demand.</p>

<blockquote>
<p>Why Node?</p>
</blockquote>

<ul class="task-list">
<li>Because it is JavaScript. Node is the reason that catapults JavaScript from a toy language to a production-ready, high-performance server-side language</li>
<li>Because of NPM (Node Package Manager). NPM provides a clean interface between the Node kernel and your packages or modules, so that the kernel stays small and let the JavaScript community fill the gaps outside of its core functionality</li>
</ul><blockquote>
<p>Why MySQL?</p>
</blockquote>

<p>MySQL fits our philosophy of sound software architecture design: it has a kernel with replaceable storage engine (plugin). That means, you can mix and match the storage engine based on your needs. Moreover, it is battle-tested and being used by Google, Facebook, Amazon among others.</p>

<blockquote>
<p>Why JavaScript editor?</p>
</blockquote>

<p>JavaScript programming due to its interpreted language nature is harder to debug compared with compiled languages, so use a code editor that has JavaScript formatting functionality (for example, JSTool for Notepad++). That way, you know when your code delimiter is in its proper place, so you can focus more on debugging semantic errors rather than syntax errors. However, Node gives you stack traces in case of errors so debugging makes it bearable nonetheless </p>

<blockquote>
<p>Why VirtualBox?</p>
</blockquote>

<p>VirtualBox enables you to run your Turnkey Linux image as a virtual machine. Unlike Vagrant, there is no need to learn a couple of commands to set it up. A virtual machine isolates your development machine so that your VM mirrors your production settings as much as possible</p>

<p><strong>Limitations</strong></p>

<p>This book is meant to get you up and running with Web application development in no time. Hence, you need to be aware of the limitations:</p>

<ul class="task-list">
<li>This book is about Web server application development so I assume you have basic knowledge of client-side development (jQuery at least)</li>
<li>Network provision is being managed by VirtualBox through Bridged Adapter and/or Host-only Adapter</li>
<li>Since the Web server and the database server are in one machine, it is effectively a two-tier architecture (client/server), not three-tier (Web server and database server are separate) nor an N-tier architecture (two or more Web servers and separate database server).</li>
<li>N-tier architecture is beyond the scope of this book so Hapi Pack and plugins are not discussed</li>
<li>Deployment is to a single computer or one virtual machine only. As such, deployment is manual using file upload with Webmin. Automating application deployment with configuration management (CM) tools like Ansible is beyond the scope of this book. Also, access to MySQL is through localhost only</li>
<li>Automated testing of user interface is not covered (read the book "Using Node.js for UI Testing" instead)</li>
<li>Turnkey Linux forces you to develop applications in terms of machines (be it bare metal, virtual machine or VPS). As such, deployment to platforms like Heroku, Deis, PaaS or IaaS and the like are definitely out of discussion </li>
</ul><h3>Download Turnkey Linux and VirtualBox</h3>

<p><strong>Download Turnkey Node.js</strong></p>

<p>Go to <a href="http://www.turnkeylinux.org/mirrors">http://www.turnkeylinux.org/mirrors</a> and download the ISO depending on your computer (you may optionally download the .sig file to verify its signature).</p>

<ul class="task-list">
<li>For 32-bit computers - download ISO with i386 suffix</li>
<li>For 64-bit computers - download ISO with amd64 suffix</li>
</ul><p>At the time of this writing, the file names are </p>

<ul class="task-list">
<li>turnkey-nodejs-13.0-wheezy-i386.iso</li>
<li>turnkey-nodejs-13.0-wheezy-amd64.iso</li>
</ul><p><strong>Download and install VirtualBox</strong></p>

<p>Download it at <a href="http://www.virtualbox.org">virtualbox.org</a>.</p>

<h3>Install Turnkey Node.js</h3>

<p>We will create a Turnkey Node.js VM on Virtualbox.</p>

<p>Please follow these specifications:</p>

<ul class="task-list">
<li><p>Name and operating system<br>
a) Type: Linux<br>
b) Version: Debian</p></li>
<li><p>Memory size: 512 MB</p></li>
<li><p>Hard drive: 40 GB</p></li>
<li><p>Hard drive file type: VDI (VirtualBox Disk Image)</p></li>
<li><p>Storage on physical hard drive: Dynamically allocated</p></li>
<li><p>File location and size: 40GB</p></li>
<li><p>System</p></li>
</ul><p>Processor tab: Enable PAE/NX</p>

<p>Now, we need to point the downloaded Turnkey Linux ISO to VM's CD/DVD drive.</p>

<ul class="task-list">
<li>Storage</li>
</ul><p>IDE Secondary Master: [CD/DVD] turnkey-nodejs-13.0-wheezy-i386.iso</p>

<ul class="task-list">
<li>Audio: Disabled</li>
</ul><p>We will now configure our VM to have two network adapters so that your VM will be able to access the Internet (in case you have one). If none, you can still access your VM from your laptop or desktop computer (host-only).</p>

<ul class="task-list">
<li>Network: </li>
</ul><p>a) Adapter 1: Bridged Adapter<br>
b) Adapter 2: Host-Only Ethernet Adapter</p>

<p>You may now install Turnkey Node by clicking Start or right arrow at VirtualBox.</p>

<p>If you are not familiar with subsequent installation questions, use these guidelines:</p>

<p>Partition Method: Guided - use entire disk<br>
Write the changes to disks: Yes<br>
Install the GRUB boot loader to the master boot record: Yes <br>
Would you like to restart now: Yes</p>

<p>Once it restarted, Turnkey Linux will ask you for a password for the root account (administrator).</p>

<p>Initialize Hub services: Skip<br>
Security updates: Skip (since this is just a developer VM)</p>

<p>The installation is complete once you get to Turnkey Linux Configuration Console (take note of the local URLs).</p>

<p>For example, this is what appears on my laptop that has Internet connectivity:</p>

<p>Web:        <a href="http://192.168.0.102">http://192.168.0.102</a><br><a href="https://192.168.0.102">https://192.168.0.102</a><br>
Web shell:  <a href="http://192.168.0.102:12320">http://192.168.0.102:12320</a><br>
Webmin:     <a href="http://192.168.0.102:12321">http://192.168.0.102:12321</a><br>
SSH/SFTP:   root@192.168.0.102 (port 22)</p>

<p>When I am offline (no Internet), the IP address is 192.168.56.101.</p>

<h3>Web shell</h3>

<p>Once you opened your browser and put the local URL for Web shell (<a href="http://192.168.0.102:12320">http://192.168.0.102:12320</a> for example), </p>

<ul class="task-list">
<li><p>Firefox will tell you that "This Connection is Untrusted". Just click "I Understand the Risks" and click the "Add Exception..." button. </p></li>
<li><p>For Google Chrome, it will say "The site's security certificate is not trusted!". Just click the "Proceed anyway" button.</p></li>
</ul><h3>Upgrade Node.js</h3>

<ul class="task-list">
<li>Open the Web shell</li>
</ul><p>Per David Walsh's post (<a href="http://davidwalsh.name/upgrade-nodejs">http://davidwalsh.name/upgrade-nodejs</a>):</p>

<ul class="task-list">
<li>Enter root credentials</li>
</ul><p>nodejs login: root<br>
Password: root password</p>

<ul class="task-list">
<li>Enter the following at the prompt:</li>
</ul><pre><code>npm install n -g
n stable
</code></pre>

<p>Output:</p>

<pre><code>root@nodejs ~# npm install n -g
npm http GET https://registry.npmjs.org/n
npm http 200 https://registry.npmjs.org/n
npm http GET https://registry.npmjs.org/n/-/n-1.2.1.tgz
npm http 200 https://registry.npmjs.org/n/-/n-1.2.1.tgz
/usr/local/bin/n -&gt; /usr/local/lib/node_modules/n/bin/n                                   
n@1.2.1 /usr/local/lib/node_modules/n  
</code></pre>

<pre><code>root@nodejs ~# n stable

     install : v0.10.29
       mkdir : /usr/local/n/versions/0.10.29
       fetch : http://nodejs.org/dist/v0.10.29/node-v0.10.29-linux-x86.tar.gz
   installed : v0.10.29
</code></pre>

<p>Alternatively, you can check the version of your installed Node.js by typing:</p>

<pre><code>node -v 
</code></pre>

<h3>Install MySQL</h3>

<pre><code>apt-get update
apt-get upgrade
apt-get install mysql-server
</code></pre>

<p>Output:</p>

<pre><code>Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
libaio1 libdbd-mysql-perl libdbi-perl libmysqlclient18 libnet-daemon-perl libplrpc-perl mysql-client-5.5 mysql-common mysql-server-5.5
mysql-server-core-5.5
Suggested packages:
libterm-readkey-perl tinyca
Recommended packages:
mailx libhtml-template-perl
The following NEW packages will be installed:
libaio1 libdbd-mysql-perl libdbi-perl libmysqlclient18 libnet-daemon-perl libplrpc-perl mysql-client-5.5 mysql-common mysql-server mysql-server-5.5
mysql-server-core-5.5
0 upgraded, 11 newly installed, 0 to remove and 0 not upgraded.
Need to get 8493 kB of archives.
After this operation, 92.0 MB of additional disk space will be used.
Do you want to continue [Y/n]?
</code></pre>

<p><strong>Secure MySQL installation</strong></p>

<pre><code>root@nodejs ~# mysql_secure_installation
</code></pre>

<p>Output:</p>

<pre><code>NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MySQL
SERVERS IN PRODUCTION USE! PLEASE READ EACH STEP CAREFULLY!
In order to log into MySQL to secure it, we'll need the current
password for the root user. If you've just installed MySQL, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.
Enter current password for root (enter for none):
OK, successfully used password, moving on...
Setting the root password ensures that nobody can log into the MySQL
root user without the proper authorisation.
You already have a root password set, so you can safely answer 'n'.
Change the root password? [Y/n] n
... skipping.
By default, a MySQL installation has an anonymous user, allowing anyone
to log into MySQL without having to have a user account created for
them. This is intended only for testing, and to make the installation
go a bit smoother. You should remove them before moving into a
production environment.
Remove anonymous users? [Y/n] y
... Success!
Normally, root should only be allowed to connect from 'localhost'. This
ensures that someone cannot guess at the root password from the network.
Disallow root login remotely? [Y/n] y
... Success!
By default, MySQL comes with a database named 'test' that anyone can
access. This is also intended only for testing, and should be removed
before moving into a production environment.
Remove test database and access to it? [Y/n] y
- Dropping test database...
ERROR 1008 (HY000) at line 1: Can't drop database 'test'; database doesn't exist
... Failed! Not critical, keep moving...
- Removing privileges on test database...
... Success!
Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.
Reload privilege tables now? [Y/n] y
... Success!
Cleaning up...
All done! If you've completed all of the above steps, your MySQL
installation should now be secure.
Thanks for using MySQL! 
</code></pre>

<p>Upon successful installation, MySQL will be included on automatic startup on server reboot.</p>

<h3>Webmin Overview</h3>

<p>At the time of this writing, Turnkey Linux is using Debian 7 and Webmin 1.630. With MySQL 5.5 installed, the entire virtual machine only consumes 81.25MB on my computer with no existing application database yet.</p>

<p>Login for Webmin is the same for Web shell:</p>

<p>Username: root<br>
Password: root password (when you installed Turnkey Node)</p>

<p>Unlike the LAMP version of Turnkey Linux, the Webmin install in Turnkey Node does not include MySQL (hence the manual installation) and thus, MySQL is not included in the Servers menu of Webmin. However, you can add MySQL in its Servers menu using modules but it is beyond the scope of this book. Alternatively, we can use the command line or Web shell when dealing with MySQL.</p>

<p>For now, it is suffice to say that we need Webmin for uploading our Node scripts and editing some configuration files to be discussed in later chapters.</p>

<h3>Install webmin-mysql</h3>

<p>Since the Turnkey Node image does not include MySQL by default, we need to install the MySQL module for Webmin. Upon successful installation, it will appear as WebMin &gt; Servers &gt; MySQL Database Server. The MySQL module enables us to create databases and tables among others which essentially offers a plain vanilla server-side version of MySQL Workbench.</p>

<ul class="task-list">
<li><p>Login to Web Shell</p></li>
<li><p>Upon login, type apt-get install webmin-mysql</p></li>
</ul><blockquote>
<p>Output</p>
</blockquote>

<div class="highlight highlight-sh"><pre>Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
webmin-mysql
<span class="m">0</span> upgraded, <span class="m">1</span> newly installed, <span class="m">0</span> to remove and <span class="m">0</span> not upgraded.
Need to get <span class="m">439</span> kB of archives.
After this operation, <span class="m">439</span> kB of additional disk space will be used.
Get:1 http://archive.turnkeylinux.org/debian/ wheezy/main webmin-mysql i386 1.630-turnkey+0 <span class="o">[</span><span class="m">439</span> kB<span class="o">]</span>
Fetched <span class="m">439</span> kB in 4s <span class="o">(</span>88.4 kB/s<span class="o">)</span>
<span class="o">[</span>master 71556ea<span class="o">]</span> saving uncommitted changes in /etc prior to apt run
<span class="m">4</span> files changed, <span class="m">11</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">4</span> deletions<span class="o">(</span>-<span class="o">)</span>
debconf: delaying package configuration, since apt-utils is not installed
Selecting previously unselected package webmin-mysql.
<span class="o">(</span>Reading database ... <span class="m">26662</span> files and directories currently installed.<span class="o">)</span>
Unpacking webmin-mysql <span class="o">(</span>from .../webmin-mysql_1.630-turnkey+0_i386.deb<span class="o">)</span> ...
Setting up webmin-mysql <span class="o">(</span>1.630-turnkey+0<span class="o">)</span> ...
Use of uninitialized value <span class="nv">$type</span> in chop at /usr/share/webmin/webmin/webmin-lib.pl line 192.
Use of uninitialized value <span class="nv">$type</span> in string eq at /usr/share/webmin/webmin/webmin-lib.pl line 196.
Installed MySQL Database Server in /usr/share/webmin/mysql <span class="o">(</span><span class="m">3448</span> kb<span class="o">)</span>
<span class="o">[</span>master dd384db<span class="o">]</span> committing changes in /etc after apt run
<span class="m">4</span> files changed, <span class="m">180</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">105</span> deletions<span class="o">(</span>-<span class="o">)</span>
create mode <span class="m">100644</span> webmin/mysql/config
Counting objects: 1167, <span class="k">done</span>.
Compressing objects: 100% <span class="o">(</span>704/704<span class="o">)</span>, <span class="k">done</span>.
Writing objects: 100% <span class="o">(</span>1167/1167<span class="o">)</span>, <span class="k">done</span>.
Total <span class="m">1167</span> <span class="o">(</span>delta 102<span class="o">)</span>, reused <span class="m">1114</span> <span class="o">(</span>delta 76<span class="o">)</span> 
</pre></div>

<h3>Turnkey Linux Configuration Console</h3>

<p>The Advanced Menu includes the following options:</p>

<ul class="task-list">
<li>Networking (no need to configure this)</li>
<li>Reboot</li>
<li>Shutdown</li>
<li>Quit (Quit the configuration console)</li>
</ul><p>When you choose Quit, you will be back to the command line (similar to the Web shell).</p>

<h3>Download your Favorite Editor</h3>

<ul class="task-list">
<li>Notepad++</li>
<li>Sublime Text</li>
<li>vim</li>
<li>insert your editor here</li>
</ul><h2>Part II. Web Server Overview</h2>

<h3>Nginx as Reverse Proxy to Node</h3>

<p>Regardless if you are going to deploy a Website on the Internet or on an intranet (private network), nginx is configured to listen on port 80. If nginx receives a request for static files like HTML/CSS/Javascript/images/etc, it handles the requests directly; otherwise it proxies the result to Node (read "Professional Website Performance" by Peter Smith).</p>

<p>For static files:</p>

<p>Client --&gt; GET logo.gif --&gt; Nginx (listening on port 80)</p>

<p>For dynamic requests:</p>

<p>Client --&gt; POST /login --&gt; Nginx (port 80) --&gt; Nginx forwards request to Node (port 8080, for example)</p>

<h3>Nginx Configuration Files</h3>

<p><strong>File: /etc/nginx/nginx.conf</strong></p>

<pre><code>user www-data;
worker_processes 4;
pid /var/run/nginx.pid;

events {
    worker_connections 768;
    # multi_accept on;
}

http {

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    # server_tokens off;

    # server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # Logging Settings
    ##

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##

    gzip on;
    gzip_disable "msie6";

    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_buffers 16 8k;
    # gzip_http_version 1.1;
    # gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    ##
    # nginx-naxsi config
    ##
    # Uncomment it if you installed nginx-naxsi
    ##

    #include /etc/nginx/naxsi_core.rules;

    ##
    # nginx-passenger config
    ##
    # Uncomment it if you installed nginx-passenger
    ##

    #passenger_root /usr;
    #passenger_ruby /usr/bin/ruby;

    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}


#mail {
#   # See sample authentication script at:
#   # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# 
#   # auth_http localhost/auth.php;
#   # pop3_capabilities "TOP" "USER";
#   # imap_capabilities "IMAP4rev1" "UIDPLUS";
# 
#   server {
#       listen     localhost:110;
#       protocol   pop3;
#       proxy      on;
#   }
# 
#   server {
#       listen     localhost:143;
#       protocol   imap;
#       proxy      on;
#   }
#}
</code></pre>

<p>A new installation of Turnkey Node has no files at /etc/nginx/conf.d folder.</p>

<p>However, there is one file named nodejs at /etc/nginx/sites-enabled folder.</p>

<p><strong>File: /etc/nginx/sites-enabled/nodejs</strong></p>

<pre><code>server {
    listen 0.0.0.0:80;
    include /etc/nginx/include/nodejs-proxy;
}

server {
    listen 0.0.0.0:443;
    include /etc/nginx/include/ssl;
    include /etc/nginx/include/nodejs-proxy;
}
</code></pre>

<p><strong>File: /etc/nginx/include/ssl</strong></p>

<pre><code>ssl                  on;
ssl_certificate      /etc/ssl/certs/cert.crt;
ssl_certificate_key  /etc/ssl/certs/cert.key;
ssl_session_timeout  5m;
ssl_protocols  SSLv2 SSLv3 TLSv1;
ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
ssl_prefer_server_ciphers   on;
</code></pre>

<p><strong>File: /etc/nginx/include/nodejs-proxy</strong></p>

<pre><code>access_log /var/log/nginx/nodejs.access.log;
error_log /var/log/nginx/nodejs.error.log;

location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;

    proxy_pass http://127.0.0.1:8000/;
    proxy_redirect off;
    proxy_buffering off;
}
</code></pre>

<blockquote>
<p>Note: Turnkey Node daemon uses port 8000 (see nodejs-proxy above) so your Node apps need to run on any allowed port except 8000.</p>
</blockquote>

<h3>Serve static files</h3>

<p>To offload dynamic requests for our Node apps, we need to configure nginx so that it serves static files from a folder of your choosing. </p>

<blockquote>
<p>In this book, we designate that folder as /var/www.</p>
</blockquote>

<p>To do so, you need to login to Webmin.</p>

<ol class="task-list">
<li><p>Webmin &gt;&gt; Tools menu &gt;&gt; Text Editor</p></li>
<li><p>Edit file: /etc/nginx/include/nodejs-proxy</p></li>
<li><p>Put the following after error_log /var/log/nginx/nodejs.error.log;</p></li>
</ol><pre><code>location /static/ {
    alias /var/www/;

    #Disable directory listing
    autoindex off;  
}
</code></pre>

<ol class="task-list">
<li><p>Save</p></li>
<li><p>Done</p></li>
</ol><p><strong>Expected content of /etc/nginx/include/nodejs-proxy:</strong></p>

<pre><code>access_log /var/log/nginx/nodejs.access.log;
error_log /var/log/nginx/nodejs.error.log;

location /static/ {
    alias /var/www/;

    #Disable directory listing
    autoindex off;
}

location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;

    proxy_pass http://127.0.0.1:8000/;
    proxy_redirect off;
    proxy_buffering off;
}
</code></pre>

<p>See <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#alias">http://nginx.org/en/docs/http/ngx_http_core_module.html#alias</a>.</p>

<p>So if we have sample.html stored at /var/www for example, we can access it like so:</p>

<pre><code>http://192.168.56.101/static/sample.html
</code></pre>

<p>On the other hand, if you are going to use Node to develop a local Web app (that is, running at localhost), you can forego nginx or any Web server as long as you use built-in Node modules (like fs and sys) or third-party middleware for serving static files.</p>

<p><strong>Reload nginx configuration</strong></p>

<p>To reflect changes in nginx configuration files, type the following from the command line:</p>

<pre><code>service nginx reload
</code></pre>

<h3>Serve dynamic requests</h3>

<p>We will further modified /etc/nginx/include/nodejs-proxy like so:</p>

<pre><code>access_log /var/log/nginx/nodejs.access.log;
error_log /var/log/nginx/nodejs.error.log;

location /static/ {
    alias /var/www/;

    #Disable directory listing
    autoindex off;
}

location /inventory/ {
  proxy_pass http://127.0.0.1:9001/;
}

location /billing/ {
  proxy_pass http://127.0.0.1:9002/;
}

location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;

    proxy_pass http://127.0.0.1:8000/;
    proxy_redirect off;
    proxy_buffering off;
}
</code></pre>

<p>If you put the following at your browser, you let nginx forward your request to a Node app listening at port 9001.</p>

<pre><code>http://192.168.56.101/inventory
</code></pre>

<p>So the path /inventory can be an inventory app, /billing can be a billing app and so on. You can namespace your apps at the nginx configuration level. This method of binding your app to any allowed port number is called <strong>port binding</strong>. </p>

<p>If you made changes to any nginx configuration file, don't forget to reload it.</p>

<pre><code>service nginx reload
</code></pre>

<h2>Part III. Node Programming Overview</h2>

<h3>Overview of Node</h3>

<p><a href="https://camo.githubusercontent.com/0c5c1c014d5ea5f5c048ee1b20d3e67c27eb2252/687474703a2f2f692e696d6775722e636f6d2f584b63616b31782e706e67" target="_blank"><img src="https://camo.githubusercontent.com/0c5c1c014d5ea5f5c048ee1b20d3e67c27eb2252/687474703a2f2f692e696d6775722e636f6d2f584b63616b31782e706e67" alt="" data-canonical-src="http://i.imgur.com/XKcak1x.png" style="max-width:100%;"></a></p>

<p>(Courtesy: <a href="http://www.aosabook.org/en/twisted.html">aosabook.org</a>)</p>

<p>Node.js uses the same event model like Twisted in Python or EventMachine for Ruby, Vert.x for JVM and others. However, programmers familiar with JavaScript on the Web browser need not learn a new language. When you structure your business logic with an event model, JavaScript callbacks in the browser would be the same in the server. Along with a functional programming alternative like Promises, EventEmitter methods like "on" and "emit" will make you feel at home like jQuery's "on" and "trigger" methods.</p>

<p><strong>Hello World in Node</strong></p>

<blockquote>
<p>Note: For Webmin and Web Shell, you may login as root. Your password is the same as the one you entered when you installed Turnkey Node.</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="c1">//hello.js</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World\n'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span> <span class="s1">'0.0.0.0'</span><span class="p">);</span>  <span class="c1">//listens on any available network interface</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Server running at port 1337'</span><span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>Save the above code in your laptop as hello.js</li>
<li>Run Turnkey Node in Virtualbox (see Part I)</li>
<li>At the Turnkey Linux Configuration Console, you will get an IP address like the following:</li>
</ul><pre><code>192.168.0.102
</code></pre>

<p>or </p>

<pre><code>192.168.56.101
</code></pre>

<ul class="task-list">
<li>Login to Webmin, click Tools &gt;&gt; Upload and Download</li>
<li>Click Upload to Server</li>
</ul><p>Files to upload: hello.js<br>
File or directory to upload to: /home/scripts</p>

<ul class="task-list">
<li>Click Upload button</li>
</ul><p><strong>Run Node script</strong></p>

<ul class="task-list">
<li>Login to Web Shell</li>
<li>Type the following at the command line (after <code>root@nodejs ~#</code>)</li>
</ul><pre><code>node /home/scripts/hello
</code></pre>

<p>Output:</p>

<pre><code>Server running at port 1337
</code></pre>

<p><strong>Run client request</strong></p>

<p>From your laptop browser, type the following (replace IP address if different):</p>

<pre><code>http://192.168.0.102:1337/
</code></pre>

<p>Output from browser:</p>

<pre><code>Hello World
</code></pre>

<h3>Restart Node Script on File Change</h3>

<p>In the course of your application development with Turnkey Node, this is going to be the workflow:</p>

<ol class="task-list">
<li>Code your Node script with your favorite editor</li>
<li>Test it</li>
<li>Upload to Turnkey Node folder</li>
<li>Start the script with <code>node [location folder] [script name]</code>
</li>
</ol><p>Once the script changes, you need to stop the script by pressing Control-C at the Web shell, then go back to steps 3 and 4 until you are done.</p>

<p>To avoid this tedious process, you can just go with steps 1 to 3 by using an npm package called hotnode. Hotnode will automatically restart your Node script as soon as it detects changes to it, no need to manually stop and start your script at the command line.</p>

<p>To install hotnode, go to the Web Shell:</p>

<pre><code>npm install hotnode -g
</code></pre>

<p>For our purposes, hotnode is small and suits just fine for local development. For actual deployment, you may use similar npm packages like nodemon, pm2, forever, etc.</p>

<p><strong>Run hotnode scripts</strong></p>

<p>Hotnode watches for files in the current working directory. If your script is on another folder, you need to change directory. For example,</p>

<pre><code>cd /home/scripts
</code></pre>

<p>Once you have changed to desired directory or folder, type</p>

<pre><code>hotnode [script name]
</code></pre>

<h3>Continuation-Passing Style (CPS)</h3>

<p>Asynchronous programming in JavaScript follows the <a href="http://en.wikipedia.org/wiki/Continuation-passing_style">continuation-passing style</a>.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//courtesy: Colin Ihrig, Pro Node.js for Developers</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>

<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf8"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Reading file..."</span><span class="p">);</span>
</pre></div>

<p>Assuming foo.txt has only the word "foo" in its content. Node has a certain threshold before it deems a running function as blocking I/O (except for explicit blocking function like readFileSync, for example). In this case, readFile is an asynchronous function so Node will execute the subsequent function which outputs </p>

<pre><code>Reading file...
</code></pre>

<p>before it then outputs </p>

<pre><code>foo
</code></pre>

<p>This counter-intuitive style of programming may be foreign to those who program in synchronous fashion like PHP. </p>

<blockquote>
<p>It is important to note that programming in Node is basically queue-based in that your tasks are in a lineup for processing within Node's <a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">event loop</a>.</p>
</blockquote>

<p><a href="https://camo.githubusercontent.com/2a86af3cf58d1ecb11c956b8e6b1532f0f716813/687474703a2f2f692e696d6775722e636f6d2f76754b536971592e706e67" target="_blank"><img src="https://camo.githubusercontent.com/2a86af3cf58d1ecb11c956b8e6b1532f0f716813/687474703a2f2f692e696d6775722e636f6d2f76754b536971592e706e67" alt="" data-canonical-src="http://i.imgur.com/vuKSiqY.png" style="max-width:100%;"></a></p>

<p>(courtesy: Ko JungHyun)</p>

<p>So back to the readFile example above, if you want the synchronous version of readFile, you would have to program like this:</p>

<div class="highlight highlight-javascript"><pre>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Reading file..."</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</pre></div>

<p>Output:</p>

<pre><code>Reading file...
foo
</code></pre>

<p><strong>Difference between synchronous and asynchronous functions</strong></p>

<ul class="task-list">
<li>synchronous function - returns the result value</li>
<li>asynchronous function - returns the result value (and error) in a callback function</li>
</ul><p>In the example above,</p>

<div class="highlight highlight-javascript"><pre><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf8"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>readFile is asynchronous function which takes an anonymous function (or callback) as its last parameter. In this case, the callback is the following:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>As a convention in Node, the parameters in a callback must follow these guidelines:</p>

<ul class="task-list">
<li>the first parameter is the error result</li>
<li>the second parameter is the successful data result</li>
</ul><p>The callback function is the continuation of an asynchronous function because the results of the latter are passed to the former. This continuation-passing style of programming may lend to the so-called "callback hell" especially when it is nested three or more levels deep. See <strong><a href="http://callbackhell.com">callbackhell.com</a></strong> for details.</p>

<p>One partial solution to callback hell is by using Node modules. I said partial because the direction of control logic is still one way (<a href="http://en.wikipedia.org/wiki/Turtles_all_the_way_down">it's turtles all the way down</a>). When you descend into callback hell, you know it is not a good abstraction.</p>

<p><a href="https://camo.githubusercontent.com/a85d953d2c7e3a58be07f1c3b3204a4165ee612e/687474703a2f2f692e696d6775722e636f6d2f5a4377766430412e6a7067" target="_blank"><img src="https://camo.githubusercontent.com/a85d953d2c7e3a58be07f1c3b3204a4165ee612e/687474703a2f2f692e696d6775722e636f6d2f5a4377766430412e6a7067" alt="" data-canonical-src="http://i.imgur.com/ZCwvd0A.jpg" style="max-width:100%;"></a></p>

<p>(courtesy: <a href="http://aitchkay.com/artsite/2011/01/29/its-turtles-all-the-way-down/">Howie Katz</a>)</p>

<p>Think of continuation-passing like this:</p>

<p><a href="https://camo.githubusercontent.com/35c119d6f9e07e631b5d54019cb198920c9388f1/687474703a2f2f692e696d6775722e636f6d2f65665a344348742e6a7067" target="_blank"><img src="https://camo.githubusercontent.com/35c119d6f9e07e631b5d54019cb198920c9388f1/687474703a2f2f692e696d6775722e636f6d2f65665a344348742e6a7067" alt="" data-canonical-src="http://i.imgur.com/efZ4CHt.jpg" style="max-width:100%;"></a></p>

<p>(courtesy: faludidesign.com)</p>

<blockquote>
<p>Once you have gone the callback route, it is like you are descending into a catacomb and stuck in its chambers further down the line. When you use a callback function, the data you need to pass around must go through that callback function. In essence, you are confined to a nested scope like a downward spiral.</p>
</blockquote>

<p><a href="https://camo.githubusercontent.com/e68cc24ee7f3b78ddbd8cdd5a4bd1225f337c54e/687474703a2f2f692e696d6775722e636f6d2f71556d35374c592e6a7067" target="_blank"><img src="https://camo.githubusercontent.com/e68cc24ee7f3b78ddbd8cdd5a4bd1225f337c54e/687474703a2f2f692e696d6775722e636f6d2f71556d35374c592e6a7067" alt="" data-canonical-src="http://i.imgur.com/qUm57LY.jpg" style="max-width:100%;"></a></p>

<p>(courtesy: papabear.ph)</p>

<p>What we need is a means of returning control (or at least the state) back to the calling function. <strong>A closure is a partial means to solve tracking state in callback functions</strong> but it does not address getting out of the callback scope.</p>

<p><strong>Closure</strong></p>

<p>Take a look at closure from <a href="http://learn.jquery.com/javascript-101/closures/">jQuery Learning Center</a> example:</p>

<p>Closures are an extension of the concept of scope. With closures, functions have access to variables that were available in the scope where the function was created. If that seems confusing, don’t worry: closures are generally best understood by example.</p>

<p>As shown in the Scope section, functions have access to changing variable values. The same sort of behavior exists with functions defined within loops – the function "sees" the change in the variable's value even after the function is defined, resulting in each function referencing the last value stored in the variable.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// Each function executed within the loop will reference</span>
<span class="c1">// the last value stored in i (5).</span>
<span class="c1">// This won't behave as we want it to - every 100 milliseconds, 5 will alert</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Closures can be used to prevent this by creating a unique scope for each iteration – storing each unique value of the variable within its scope.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// Using a closure to create a new private scope</span>
<span class="c1">// fix: “close” the value of i inside createFunction, so it won't change</span>
<span class="kd">var</span> <span class="nx">createFunction</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Closures are fine as long as state is contained within your function. What if we want to get out of the callback scope? The problem with callback hell is <a href="http://en.wikipedia.org/wiki/Coupling_(computer_programming)">tight coupling</a> between control logic and application logic.</p>

<h3>Promise-based Programming</h3>

<blockquote>
<p>More detailed introduction of Promise-based programming with my free guidebook "Web Development Fundamentals" at <a href="http://itjumpstart.wordpress.com">ITJUMPSTART</a></p>
</blockquote>

<p>Take a look again at the callback function:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>If all the functionality in a callback ends right there within itself, it is self-contained and we are done. </p>

<blockquote>
<p>What if we need to communicate the error or the success result to another logic outside our callback function? </p>
</blockquote>

<p>For example, imagine posting a database transaction. It is either posted or not (there is no in-between) and we need to tell the Web page of its result.</p>

<p>Is there a way to continue our logic flow without using callback?</p>

<p>Fortunately, there is. Enter Deferred, Future or Promise.</p>

<blockquote>
<p>In this case, instead of using a callback which is basically <a href="https://blog.jcoglan.com/2013/03/30/callbacks-are-imperative-promises-are-functional-nodes-biggest-missed-opportunity/">imperative programming</a>, we can return an <strong>object</strong> which <strong>defers</strong> the processing to a subsequent function. </p>
</blockquote>

<p>That object holds the values (or state) we are interested in but we can evaluate it later ("<strong>lazy evaluation</strong>"); hence, it is called "<a href="http://en.wikipedia.org/wiki/Evaluation_strategy">call-by-future</a>", a key concept in functional programming.</p>

<p>I recommend that you read "Async JavaScript" by Trevor Burnham. You may also read Bacon.js and try its examples. The concept of Property and EventStream is the same as the concept of Deferred as far as lazy evaluation is concerned.</p>

<p>The Deferred object that resolves or rejects a situation essentially acts as the control logic whereas the event handlers in jQuery Deferred object's done and fail methods act as the app logic.</p>

<p>In the parlance of <a href="https://github.com/kriskowal/q">Q library</a> in Node, we can rewrite the readFile callback as follows:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</pre></div>

<p>From <a href="http://promises-aplus.github.io/promises-spec/">Promises/A+</a> spec:</p>

<blockquote>
<p>A promise represents the <strong>eventual</strong> result of an asynchronous operation. The primary way of interacting with a promise is through its "then" method, which registers callbacks to receive either a promise’s eventual value or the reason why the promise cannot be fulfilled.</p>
</blockquote>

<p>The difference between a deferred and a promise:</p>

<ul class="task-list">
<li>a deferred can be triggered directly (resolve, reject or notify)</li>
<li>unlike deferred, a promise only lets you 1) to attach a callback which can go on with its function or 2) return another promise (chaining like jQuery)</li>
</ul><h3>Nested Callback vs Promises</h3>

<blockquote>
<p>Note: Callback vs promises is akin to religious wars like Debian vs CentOS. Software is all about advantages and trade-offs. Be sure you know what you are dealing with. Read articles by <a href="https://blog.jcoglan.com/2013/04/01/callbacks-promises-and-simplicity/">James Coglan</a>, <a href="http://sealedabstract.com/code/broken-promises/">Drew Crawford</a> and <a href="http://www.futurealoof.com/posts/broken-promises.html">Mikeal Rogers</a>.</p>
</blockquote>

<p>So far, our code has gone into some nested callback. In this book, I will introduce some Promise-based code since it is easier to reason about than nested callbacks. Also, I am going to use a Node library called when.js from CujoJS.com. <strong>See when.js library in action being used by <a href="https://github.com/tryghost/Ghost">Ghost blog engine</a></strong>. Compare the following code courtesy of node-mysql example.</p>

<p>Nested callback</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
        <span class="nx">host</span> <span class="o">:</span> <span class="s1">'localhost'</span><span class="p">,</span>
        <span class="nx">user</span> <span class="o">:</span> <span class="s1">'me'</span><span class="p">,</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="s1">'secret'</span>
    <span class="p">});</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1 + 1 AS solution'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'The solution is: '</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">solution</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</pre></div>

<p>One way to getting around nested callback is by wrapping a given Node library function into a function itself that returns a promise. The deferred object acts as the control logic while the promise serves as application logic (example below). See "Control Logic vs Application Logic" section at Part III.</p>

<p>Using a promise-based library called <a href="https://github.com/cujojs/when">when.js</a>.</p>

<pre><code>npm install when
</code></pre>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'when'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
        <span class="nx">host</span> <span class="o">:</span> <span class="s1">'localhost'</span><span class="p">,</span>
        <span class="nx">user</span> <span class="o">:</span> <span class="s1">'me'</span><span class="p">,</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="s1">'secret'</span>
    <span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">testWhen</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1 + 1 AS solution'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error with query"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">'The solution is: '</span> <span class="o">+</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">solution</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">testWhen</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">success</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</pre></div>

<p>Output:</p>

<pre><code>The solution is: 2 
</code></pre>

<h3>Promise-based Error Handling</h3>

<p>Test deferOuter</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'when'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">deferOuter</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on outer"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferInner</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on inner"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">deferOuter</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferInner</span><span class="p">).</span><span class="k">catch</span> <span class="p">(</span><span class="nx">onError</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Output:</p>

<pre><code>error on outer
</code></pre>

<p>Test deferInner</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'when'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">deferOuter</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on outer"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferInner</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on inner"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">deferOuter</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferInner</span><span class="p">).</span><span class="k">catch</span> <span class="p">(</span><span class="nx">onError</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Output:</p>

<pre><code>error on inner
</code></pre>

<h3>Promise-based Chaining</h3>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'when'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">deferOuter</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on outer"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s2">"outer"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferInner</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"error on inner"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span> <span class="o">+</span> <span class="s2">" + inner"</span><span class="p">);</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">deferOuter</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferInner</span><span class="p">).</span><span class="k">catch</span> <span class="p">(</span><span class="nx">onError</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Output:</p>

<pre><code>outer + inner
</code></pre>

<p>The beauty of promises are three-fold in this code snippet.</p>

<ol class="task-list">
<li>You can chain promises such that the input of one can be fed to another (like Step library)</li>
<li>You can handle an error outside of the function where you encountered it</li>
<li>You can easily read the control flow from top to bottom</li>
</ol><blockquote>
<p>Notes: </p>
</blockquote>

<ul class="task-list">
<li><p>Promise-based libraries like when.js, RSVP.js, Q and others each has their own spin with syntax. The important thing is that it must conform to Promises/A+ specification.</p></li>
<li><p>The promise then method itself returns a promise regardless whether it resolves to a value or not. That's why we are able to chain them, but the chain would stop at any point where it was rejected</p></li>
</ul><h3>Event-Driven Architecture</h3>

<p>If you are still confused with callback and deferred objects, this is the main event you are waiting for (pun intended).</p>

<p>Using events is another way to separate control logic from application logic.</p>

<blockquote>
<p>Note: The notification feature of Deferred objects is similar in principle as Node EventEmitter. The Deferred object notifies a promise listener through the latter's "onProgress" interface along with optional data.</p>
</blockquote>

<p>Just as there is onclick event in presentation tier, we can decompose our business logic into events that are triggered by our control logic (main script) and attach the corresponding event handlers (application logic).</p>

<p>To illustrate, here is a simple diagram.</p>

<p>User interface (Presentation Tier) ------ App (Logic Tier) ------ Database (Storage Tier)</p>

<p><a href="https://camo.githubusercontent.com/574a6de346805acd0a5d7c71962439170ffb0503/687474703a2f2f692e696d6775722e636f6d2f785359553930592e6a7067" target="_blank"><img src="https://camo.githubusercontent.com/574a6de346805acd0a5d7c71962439170ffb0503/687474703a2f2f692e696d6775722e636f6d2f785359553930592e6a7067" alt="" data-canonical-src="http://i.imgur.com/xSYU90Y.jpg" style="max-width:100%;"></a></p>

<p>In turn, the logic tier looks like this:</p>

<ol class="task-list">
<li>Event Emitter -- Callback</li>
<li><p>Deferred -- Promise.then -- Callback</p></li>
</ol><ul class="task-list">
<li><p>promise, deferred, future - an object that holds state be it a string, boolean, number, array or even another object. In the case of Web applications, we want to capture the success/error result (akin to a closure) so we can propagate it to the Web user in hapi's request/reply context; hence, escaping the continuation-passing style inherent with callback functions</p></li>
<li><p>callback - since Node is using the <strong>function (error, data) signature</strong>, we will not process the error/data right away to avoid callback hell. Instead, we can let the deferred object return a  promise object that will then process the attached success/failure callback</p></li>
</ul><blockquote>
<p>An event is the point of demarcation between control logic and application logic for event-driven apps (and promise-based programming too).</p>
</blockquote>

<ul class="task-list">
<li>with Node, there is the EventEmitter API. </li>
<li>with jQuery, there are "on" and "trigger" methods. </li>
</ul><p>With EventEmitter, the "emit" method acts as the control logic whereas the "on" method acts as the application logic. </p>

<p>The <strong>event name</strong> acts as the <strong>interface</strong> between control logic and application logic.</p>

<p>The <strong>objective</strong> here is to <strong>maximize the application logic into modules</strong>, and to <strong>minimize the control logic</strong> in our <strong>main script</strong>.</p>

<p>If you will notice, there is no clash between functional programming (promise) and imperative programming (callback) as long as you are using event-driven architecture. Instead, the high-level control logic which exercises lazy evaluation as much as possible complements with the low-level callback functions. While the control logic acts like the Army general dishing out instructions, you may think of callback functions as soldiers in the battle field which get the job done.</p>

<h3>Control Logic vs Application Logic</h3>

<p>control logic - event dispatcher, state control, error handling, deferred (main script)<br>
application logic - event handler, promise.then (callback function)</p>

<p>Since this book is about HTTP-based applications (using hapi framework in particular), here are the <strong>pseudocode</strong> signatures of our control and application logic: </p>

<p>Application logic is further broken down into two types:</p>

<ol class="task-list">
<li>login request </li>
<li>business logic (route handler)</li>
</ol><div class="highlight highlight-javascript"><pre><span class="c1">//this is a module (application logic)</span>

<span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">require</span> <span class="nx">needed</span> <span class="nx">modules</span>

    <span class="nx">extract</span> <span class="nx">request</span> <span class="nx">payload</span>

    <span class="nx">initiliaze</span> <span class="nx">database</span> <span class="nx">connection</span>

    <span class="nx">Use</span> <span class="nx">Step</span> <span class="nx">or</span> <span class="nx">Promise</span><span class="o">-</span><span class="nx">based</span> <span class="nx">library</span> <span class="k">for</span> <span class="nx">database</span> <span class="nx">queries</span> <span class="nx">that</span> <span class="nx">feed</span> <span class="nx">its</span> <span class="nx">output</span> <span class="nx">to</span> <span class="nx">subsequent</span> <span class="nx">query</span>

    <span class="nx">generate</span> <span class="nx">token</span>

    <span class="k">return</span> <span class="nx">token</span> <span class="nx">to</span> <span class="nx">user</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">routeHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">require</span> <span class="nx">needed</span> <span class="nx">modules</span>

    <span class="nx">extract</span> <span class="nx">request</span> <span class="nx">payload</span> <span class="nx">including</span> <span class="nx">token</span>

    <span class="nx">verify</span> <span class="nx">token</span>

    <span class="k">if</span> <span class="nx">token</span> <span class="nx">is</span> <span class="nx">invalid</span><span class="p">,</span> <span class="k">return</span> <span class="nx">error</span> <span class="nx">message</span>

    <span class="k">if</span> <span class="nx">token</span> <span class="nx">is</span> <span class="nx">valid</span><span class="p">,</span> 
        <span class="nx">proceed</span> <span class="kd">with</span> <span class="nx">business</span> <span class="nx">logic</span> 
        <span class="k">do</span> <span class="nx">not</span> <span class="k">throw</span> <span class="nx">errors</span><span class="p">,</span> <span class="nx">handle</span> <span class="nx">them</span>
        <span class="k">return</span> <span class="nx">the</span> <span class="nx">token</span> <span class="nx">along</span> <span class="kd">with</span> <span class="nx">optional</span> <span class="nx">data</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">login</span><span class="p">,</span> <span class="nx">login</span><span class="p">,</span>
    <span class="nx">routeHandler</span> <span class="o">:</span> <span class="nx">routeHandler</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<blockquote>
<p>Notes:</p>
</blockquote>

<ul class="task-list">
<li>error handling is the responsibility of application logic. </li>
<li>control logic is in our main script (index.js) and our application logic is separated as modules.</li>
<li>more code at "Breaking Code into Modules" section at Part VI</li>
</ul><div class="highlight highlight-javascript"><pre><span class="c1">//index.js (control logic)</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="c1">//GET, POST</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span> 
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/pathname'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">routeHandler</span>
<span class="p">});</span>
</pre></div>

<p><strong>Deferred and Promise</strong></p>

<ul class="task-list">
<li>Control Logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</pre></div>

<div class="highlight highlight-javascript"><pre><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>Application logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">);</span>
</pre></div>

<p>where success is a callback like <code>function(data) { //handle data... }</code><br>
and failure is a callback like <code>function(error) { //handle error... }</code></p>

<p>See "Nested Callback vs Promises" section at Part VI.</p>

<p><strong>Event Emitter</strong></p>

<ul class="task-list">
<li>Control logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</pre></div>

<p>In Node, data is optional but if it is provided, by convention (in this book) data is always of object type regardless if it has one or more key-value pair since the application logic needs to know the data schema anyway.</p>

<ul class="task-list">
<li>Application logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
</pre></div>

<p>where listener is a named function.</p>

<p>Examples:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">listener</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//functionality here</span>
<span class="p">}</span>
</pre></div>

<p>or if it has data,</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">listener</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//handle data</span>
<span class="p">}</span>
</pre></div>

<h3>Node Modules</h3>

<p><strong>Structure of a Node program</strong></p>

<ol class="task-list">
<li>Control logic - main script</li>
<li>Application logic - user modules</li>
</ol><p><strong>Three types of Node modules</strong></p>

<ol class="task-list">
<li>Core modules - built-in Node modules like fs, http, net, Stream, Buffer, Events, etc</li>
<li>Commandline modules - command line tools like browserify, hotnode, n (node version manager), etc</li>
<li>User modules - your application logic (written in JavaScript or C/C++)</li>
</ol><p>In this book, we will discuss about user modules written in JavaScript only.</p>

<p><strong>Run a Node script</strong></p>

<p>When you run a Node script, Node assumes the script is located at your current working directory.</p>

<p><code>node [script name]</code></p>

<p>or </p>

<p><code>hotnode [script name]</code></p>

<p>However, you may also type the absolute path of the script. For example,</p>

<pre><code>node /home/scripts/main
</code></pre>

<h3>Core and user modules</h3>

<p><strong>Core modules</strong></p>

<p>When you "require" core modules like http or fs, it is automatically resolved by Node because it is built-in within the Node runtime.</p>

<p><strong>User modules</strong></p>

<p>Your user modules can be loaded in three ways:</p>

<ul class="task-list">
<li>absolute path </li>
</ul><div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'/home/myapp/modules/modulename'</span><span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>relative path</li>
</ul><div class="highlight highlight-javascript"><pre>
<span class="c1">//if module1 is folder, looks for main js file in package.json or index.js</span>
<span class="kd">var</span> <span class="nx">module1</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./module1'</span><span class="p">);</span>   

<span class="c1">//looks for module2.js within current directory    </span>
<span class="kd">var</span> <span class="nx">module2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./module2'</span><span class="p">);</span>  

<span class="c1">//looks for module3.js inside parent folder (above current directory)     </span>
<span class="kd">var</span> <span class="nx">module3</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../module3'</span><span class="p">);</span>  

<span class="c1">//looks for module4.js below current directory in lib subfolder    </span>
<span class="kd">var</span> <span class="nx">module4</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./lib/module4'</span><span class="p">);</span>   

<span class="c1">//looks for module5.js above current directory in lib subfolder</span>
<span class="kd">var</span> <span class="nx">module5</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../lib/module5'</span><span class="p">);</span>  
</pre></div>

<ul class="task-list">
<li>node_modules folder</li>
</ul><div class="highlight highlight-javascript"><pre><span class="c1">//looks for modulename.js in node_modules folder all the way up to root</span>
<span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'modulename'</span><span class="p">);</span>       
</pre></div>

<p>For more details, see <a href="http://nodejs.org/api/modules.html">http://nodejs.org/api/modules.html</a>.</p>

<blockquote>
<p>Note: Under Turnkey Linux, when you open the Web Shell using the root account, your current working directory is /root.</p>
</blockquote>

<pre><code>root@nodejs ~# pwd
</code></pre>

<p>Output:</p>

<pre><code>/root
</code></pre>

<h3>Packages or Modules?</h3>

<p>Packages are user modules that are published in the NPM registry and thus, they can be called public packages. However, your modules need not be in public so it can stay within a private NPM repository, a version control system or just plain file system. In this book, packages are simply user/non-core modules whether it's public or private.</p>

<p>When you import a package from the NPM registry (like <code>npm install packagename</code>), Node installs it in a node_modules subfolder by default under your current working directory. For example,</p>

<pre><code>npm install mysql
</code></pre>

<p>After successful installation of mysql, it will be located at /node_modules/mysql under whatever is the current working directory.</p>

<p>In our case (assuming you login at the Web Shell),</p>

<pre><code>/root/node_modules/mysql
</code></pre>

<p>If package A depends on another package B, C and D, those package dependencies will be also installed under node_modules of package A.</p>

<p>For example, if package A is mysql where it depends on three more packages namely:</p>

<pre><code>bignumber.js  
readable-stream  
require-all
</code></pre>

<p>Those three packages will be located on its respective folder under</p>

<pre><code>/root/node_modules/mysql/node_modules
</code></pre>

<p>Of course, Node does this automatically for you. My purpose is to illustrate the concept of the node_modules folder which can be nested with the same name for package dependencies.</p>

<blockquote>
<p>Note: Sometimes, you may see code like <code>require('./modulename')</code> which simply means that the module is located at the same directory as the Node script. I prefer that you place your user modules or private packages under the standard node_modules subfolder so that your "require" function is plain and uniform with no <code>"./"</code> Also, see why using <a href="http://codeofrob.com/entries/stop-using-relative-paths-in-your-javascripts.html">relative paths</a> is brittle. It is better to segment your business logic into folders under node_modules folder and let NPM resolves the dependencies where it shines.</p>
</blockquote>

<p><strong>Global packages</strong></p>

<p>When you install a package, the package author may specify the global option (-g). For example,</p>

<pre><code>npm install packagename -g
</code></pre>

<p>Global packages are usually command line tools like browserify, forever, Node version manager such as "n", etc. By convention, Node stores global packages under <strong>/usr/local/lib/node_modules</strong>.</p>

<h3>Browserify</h3>

<p>Node modules are great for server-side scripting. What if you want to reuse your Node modules in the browser? With <a href="http://browserify.org/">Browserify</a>, it lets you require('modules') in the browser by bundling up all of your dependencies.</p>

<p>In this book, we will use the <a href="https://github.com/spumko/joi">joi</a> module for both client-side and server-side data validation.</p>

<p>Here is how to do it:</p>

<pre><code>npm install browserify -g
</code></pre>

<pre><code>npm install joi
</code></pre>

<pre><code>browserify -r [absolute path of the module]:[module name] &gt; [javascript file name] 
</code></pre>

<p>For example:</p>

<pre><code>browserify -r /usr/local/lib/node_modules/joi/lib/index.js:joi &gt; bundle.js 

</code></pre>

<p>Remember that Node installs all global modules (those installed with -g option) at this folder:</p>

<pre><code>/usr/local/lib/node_modules
</code></pre>

<ul class="task-list">
<li>The option -r tells browserify that we will use the require function in the browser.</li>
<li>
<code>/usr/local/lib/node_modules/joi/lib/index.js</code> is the absolute path of index.js of the module we want to browserify</li>
<li>
<code>joi</code> is the module name we will pass to the require function</li>
<li>
<code>bundle.js</code> is the name we will reference in our HTML like <code>&lt;script src="js/bundle.js"&gt;&lt;/script&gt;</code>
</li>
<li>you can download the resulting js file from the current working directory where you issued the command (Download from server tab from Webmin &gt; Tools &gt; Upload and Download)</li>
</ul><p>This is our simple HTML page to use joi in the Web browser (courtesy of joi documentation)</p>

<div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>joi test example<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;br&gt;</span>

browserify -r /usr/local/lib/node_modules/joi/lib/index.js:joi &gt; bundle.js

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/bundle.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script&gt;</span>

<span class="kd">var</span> <span class="nx">Joi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'joi'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
    <span class="nx">username</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">alphanum</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9]{3,30}/</span><span class="p">),</span>
    <span class="nx">access_token</span><span class="o">:</span> <span class="p">[</span><span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">()],</span>
    <span class="nx">birthyear</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">integer</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1900</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">2013</span><span class="p">),</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">()</span>
<span class="p">}).</span><span class="kd">with</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'birthyear'</span><span class="p">).</span><span class="nx">without</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="s1">'access_token'</span><span class="p">);</span>

<span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">'uc'</span><span class="p">,</span> <span class="nx">birthyear</span><span class="o">:</span> <span class="mi">1899</span> <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> 

  <span class="c1">//if valid, value = null</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span>
  <span class="p">}</span>

<span class="p">});</span>  

<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>

<p>When you run the HTML above, it will alert </p>

<p><code>ValidationError: username length must be at least 3 characters long</code></p>

<p>However, we also expect an error message for the birthyear since we passed 1899. To get all error messages in one fell swoop, we can pass the option <code>{abortEarly: false}</code> as third parameter to the Joi.validate method.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">'uc'</span><span class="p">,</span> <span class="nx">birthyear</span><span class="o">:</span> <span class="mi">1899</span> <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="p">{</span><span class="nx">abortEarly</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> 

  <span class="c1">//if valid, value = null</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span>
  <span class="p">}</span>

<span class="p">});</span>  
</pre></div>

<p>The expected error would then be:</p>

<pre><code>ValidationError: username length must be at least 3 characters long. birthyear must be larger than or equal to 1900
</code></pre>

<p>See "The Joi of Validation" blog post at <a href="http://vawks.com/blog/2014/03/22/the-joi-of-validation/">Vawks Clamantis</a> for more details.</p>

<h2>Part IV. Web Application Programming</h2>

<h3>Serving static files</h3>

<p>See "Serve static files" section under Part II. Web Server Overview.</p>

<h3>Clean URL, not GET vs POST</h3>

<p>You may have heard of the GET vs POST debate but in the context of static page apps, it does not matter much. After all, this book is not concerned about media or SEO-friendly sites. Our concern here is about business Web apps that need user login before access can be granted. Second, each API request needs to be authenticated anyway.</p>

<p>A <a href="http://www.indexhibit.org/tutorials/getting-started/enable-clean-urls/">clean URL</a> (aka semantic URL) does not contain a query string within the URL. For example (courtesy: Wikipedia),</p>

<p>Ugly URL</p>

<ul class="task-list">
<li><a href="http://example.com/index.php?page=foo">http://example.com/index.php?page=foo</a></li>
<li><a href="http://example.com/index.php?page=consulting/marketing">http://example.com/index.php?page=consulting/marketing</a></li>
<li><a href="http://example.com/products?category=2&amp;pid=25">http://example.com/products?category=2&amp;pid=25</a></li>
<li><a href="http://example.com/cgi-bin/feed.cgi?feed=news&amp;frm=rss">http://example.com/cgi-bin/feed.cgi?feed=news&amp;frm=rss</a></li>
<li><a href="http://example.com/services/index.jsp?category=legal&amp;id=patents">http://example.com/services/index.jsp?category=legal&amp;id=patents</a></li>
<li><a href="http://example.com/kb/index.php?cat=8&amp;id=41">http://example.com/kb/index.php?cat=8&amp;id=41</a></li>
<li><a href="http://example.com/index.php?mod=profiles&amp;id=193">http://example.com/index.php?mod=profiles&amp;id=193</a></li>
</ul><p>Clean URL</p>

<ul class="task-list">
<li><a href="http://example.com/foo">http://example.com/foo</a></li>
<li><a href="http://example.com/consulting/marketing">http://example.com/consulting/marketing</a></li>
<li><a href="http://example.com/products/2/25">http://example.com/products/2/25</a></li>
<li><a href="http://example.com/news.rss">http://example.com/news.rss</a></li>
<li><a href="http://example.com/services/legal/patents">http://example.com/services/legal/patents</a></li>
<li><a href="http://example.com/kb/8/41">http://example.com/kb/8/41</a></li>
<li><a href="http://example.com/profiles/193">http://example.com/profiles/193</a></li>
</ul><p>With clean URL in mind, you will need to get it right at the API design stage. Just bear in mind that GET is used for read-only requests while POST is used for write-only requests like posting data to your Web application.</p>

<h3>Data validation</h3>

<p><strong>Client-side Data Validation</strong></p>

<p>Most articles on client-side data validation prefer what I call "eager evaluation", that is, there are a lot of event handlers on the Web page checking each field for validity on particular events. While this makes for a "responsive" and "pro-active" user experience, there is too much "noise" in your code. I am not saying you avoid this kind of "eager evaluation" but I prefer a "lazy evaluation" where you only validate when the user has clicked the "Submit" button.</p>

<p>Here is an example of error message from PayPal Virtual Terminal:</p>

<pre><code>Check your information

Some of your information may be missing or incomplete. Please check the following items:

    Please enter net amount
    Please select transaction type
    The credit or debit card number you entered is empty or invalid. Please check you entry and try again.
    The month is missing, occurs in the past, or is incorrectly formatted. Enter a date in the future or a valid 2-digit month.
    Expiration date
    The CSC is incorrectly formatted. Please check the following items:
        For all credit cards, except American Express, please enter a 3-digit number.
        For American Express cards please enter a 4-digit number. 
    Enter the first name of the person for billing.
    Enter the last name of the person for billing.
    Enter a valid address for billing.
    Enter a valid city for billing.
    Enter a valid state for billing.
    Enter a valid ZIP code for billing.
</code></pre>

<p>It lumps the error message in one big notice right at the top of the Web page. Here you don't check for "focus" and "blur" events; instead, you simply iterate over all HTML elements and throw the error in one fell swoop. Sometimes, less is more but this kind of lazy evaluation is purely subjective and simply my personal preference. YMMV.</p>

<p>See the 'Browserify' section under Part III for details.</p>

<p><strong>Server-side Data Validation</strong></p>

<p>Since we are using Node, we can use JavaScript to implement both client-side and server-side data validation. In this book, we will use the joi module. Code will follow in later chapter but for now, it is suffice to say that we can have our server-side Node script (like below) to be used in the Web browser using the excellent tool called Browserify.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Joi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'joi'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
    <span class="nx">username</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">alphanum</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9]{3,30}/</span><span class="p">),</span>
    <span class="nx">access_token</span><span class="o">:</span> <span class="p">[</span><span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">(),</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">()],</span>
    <span class="nx">birthyear</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">integer</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1900</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">2013</span><span class="p">),</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">()</span>
<span class="p">}).</span><span class="kd">with</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="s1">'birthyear'</span><span class="p">).</span><span class="nx">without</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="s1">'access_token'</span><span class="p">);</span>
</pre></div>

<h3>Event-Driven Programming</h3>

<p>In jQuery, take a look at the click method.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#target"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//event handler code here</span>
<span class="p">}</span>
</pre></div>

<p>The same click method is semantically the same with the "on" method with the appropriate event name parameter.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#target"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//event handler code here</span>
<span class="p">}</span>
</pre></div>

<p>The jQuery "click" method is a convenience or shorthand function for the "click" event. If we port this kind of event binding to our business logic in Node, our callback handler would be self-contained and will not lead to callback hell because of separation of concern (that is, we can separate the control logic from business/application logic using events). </p>

<p>In jQuery, we use "trigger" method for the control logic and the "on" method for the application logic.</p>

<ul class="task-list">
<li>jQuery control logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#target"</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">optional</span> <span class="nx">data</span><span class="p">)</span>
</pre></div>

<ul class="task-list">
<li>jQuery application logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#target"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">optional</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</pre></div>

<p>Here is the equivalent in Node. </p>

<blockquote>
<p>Note that the event handler in jQuery is called handler while in Node, it is called listener. Both are semantically the same.</p>
</blockquote>

<ul class="task-list">
<li>Node control logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">optional</span> <span class="nx">data</span><span class="p">)</span>
</pre></div>

<ul class="task-list">
<li>Node application logic</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
</pre></div>

<p>For example,</p>

<div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">"withdraw"</span><span class="p">,</span> <span class="p">{</span> <span class="nx">userID</span><span class="o">:</span> <span class="mi">147</span><span class="p">,</span> <span class="nx">acct</span><span class="o">:</span> <span class="s2">"savings"</span><span class="p">,</span> <span class="nx">amount</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>

<div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"withdraw"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//handle obj to SQL transaction layer like node-mysql for example</span>
<span class="p">})</span>
</pre></div>

<blockquote>
<p>It is important to note that you organize event names into a naming convention of your choosing.</p>
</blockquote>

<p><strong>Detach Event Handlers</strong></p>

<p>The only thing that is constant is change. When your business logic changes, you need to detach existing event handlers and replace it with a new one.</p>

<ul class="task-list">
<li>Node</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">emitter</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">"event name"</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span>
</pre></div>

<ul class="task-list">
<li>jQuery</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#target"</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">"event name"</span> <span class="p">[,</span> <span class="nx">selector</span> <span class="p">]</span> <span class="p">[,</span> <span class="nx">handler</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>

<p>In jQuery, you can even specify the event handler to be detached. This is more granular than in Node because with jQuery, you can refactor your code without breaking the interface which is the event name. That is, you can just turn off an old handler but retain the same event name. If you need this kind of granularity, you may use the Node version of jQuery in your server-side business logic. This kind of turning on/off an event handler lends to powerful, plug-and-play and easy-to-maintain program.</p>

<p><strong>Thin client vs fat client</strong></p>

<p>I prefer that you put the bulk of business logic on the server side while data validation and minimal interaction logic on the user interface as much as possible.</p>

<h3>RESTful API with Hapi</h3>

<p>Why Hapi? See the <a href="http://hueniverse.com/2012/12/20/hapi-a-prologue/">rationale</a> behind Hapi from its lead developer.</p>

<p>So without further ado, we will proceed to creating a <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> app. Login to Web Shell, then create a new folder named myapp and change directory to that folder. But before that, install hapi. At the time of writing, hapi version is 6.0.</p>

<pre><code>npm install hapi

mkdir myapp

cd myapp
</code></pre>

<p><strong>Create a Server</strong></p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="nx">Server</span><span class="p">([</span><span class="nx">host</span><span class="p">],</span> <span class="p">[</span><span class="nx">port</span><span class="p">],</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span>
</pre></div>

<p>Creates a new server instance with the following arguments:</p>

<ul class="task-list">
<li><p><code>host</code> - the hostname, IP address, or path to UNIX domain socket the server is bound to. Defaults to 0.0.0.0 which means any available network interface. Set to 127.0.0.1 or localhost to restrict connection to those coming from the same machine. If host contains a '/' character, it is used as a UNIX domain socket path and if it starts with '.\pipe' as a Windows named pipe.</p></li>
<li><p><code>port</code> - the TCP port the server is listening to. Defaults to port 80 for HTTP and to 443 when TLS is configured. To use an ephemeral port, use 0 and once the server is started, retrieve the port allocation via server.info.port.</p></li>
<li><p><code>options</code> - An object with the server configuration as described in server options.</p></li>
</ul><p>Alternatively,</p>

<div class="highlight highlight-javascript"><pre><span class="nx">createServer</span><span class="p">([</span><span class="nx">host</span><span class="p">],</span> <span class="p">[</span><span class="nx">port</span><span class="p">],</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span>
</pre></div>

<p>Example from hapi documentation:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Handler in top level</span>

<span class="kd">var</span> <span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Hello world!'</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">hello</span>
<span class="p">});</span>

<span class="c1">// Handler in config</span>

<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">cache</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">expiresIn</span> <span class="o">:</span> <span class="mi">5000</span>
    <span class="p">},</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">reply</span><span class="p">({</span>
            <span class="nx">name</span> <span class="o">:</span> <span class="s1">'John'</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/user'</span><span class="p">,</span>
    <span class="nx">config</span> <span class="o">:</span> <span class="nx">user</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Server started at: '</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>

<span class="p">});</span>
</pre></div>

<p>In our example, we can use any allowed port except port 8000 because it is already being used by Turnkey Node daemon. Our VM is running as a separate process so we need to know its IP address from the Turnkey Linux Configuration Console.</p>

<p>For instance in my computer, it is accessible through this:</p>

<pre><code>http://192.168.0.104:8080
</code></pre>

<p>Output:</p>

<pre><code>Hello world!
</code></pre>

<blockquote>
<p>Note that we can get rid of typing 8080 at the URL by modifying an nginx configuration file (see "Serve dynamic requests" at Part II).</p>
</blockquote>

<p>If you include the following at /etc/nginx/include/nodejs-proxy</p>

<pre><code>location /app/ {
    proxy_pass http://127.0.0.1:8080/;
}
</code></pre>

<p>the URL would then become <code>http://192.168.0.104/app</code> and it would output the same <code>Hello world!</code></p>

<p>In the same vein, </p>

<pre><code>http://192.168.0.104:8080/user
</code></pre>

<p>would just become</p>

<pre><code>http://192.168.0.104/app/user
</code></pre>

<p>Output:</p>

<div class="highlight highlight-javascript"><pre><span class="p">{</span><span class="s2">"name"</span><span class="o">:</span><span class="s2">"John"</span><span class="p">}</span>
</pre></div>

<p><strong>Routing</strong></p>

<p>The heart of any RESTful API framework is routing.</p>

<p>The server.route method takes an object parameter with at least three required key/value options:</p>

<ul class="task-list">
<li><p><code>path</code> - the absolute path used to match incoming requests (must begin with '/'). Incoming requests are compared to the configured paths based on the server router configuration option. The path can include named parameters enclosed in {} which will be matched against literal values in the request as described in <strong>Path parameters</strong>.</p></li>
<li><p><code>method</code> - the HTTP method. Typically one of 'GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'. Any HTTP method is allowed, except for 'HEAD'. Use '*' to match against any HTTP method (only when an exact match was not found, and any match with a specific method will be given a higher priority over a wildcard match). Can be assigned an array of methods which has the same result as adding the same route with different methods manually.</p></li>
<li><p><code>handler</code> - the function called to generate the response after successful authentication and validation. The handler function is described in <strong>Route handler</strong>. If set to a string, the value is parsed the same way a prerequisite server method string shortcut is processed. </p></li>
</ul><p><strong>Path processing</strong></p>

<p>The router iterates through the routing table on each incoming request and executes the first (and only the first) matching route. Route matching is done on the request path only (excluding the query and other URI components). Requests are matches in a deterministic order where the order in which routes are added does not matter. The routes are sorted from the most specific to the most generic. For example, the following path array shows the order in which an incoming request path will be matched against the routes:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'/'</span><span class="p">,</span>
    <span class="s1">'/a'</span><span class="p">,</span>
    <span class="s1">'/b'</span><span class="p">,</span>
    <span class="s1">'/ab'</span><span class="p">,</span>
    <span class="s1">'/a{p}b'</span><span class="p">,</span>
    <span class="s1">'/a{p}'</span><span class="p">,</span>
    <span class="s1">'/{p}b'</span><span class="p">,</span>
    <span class="s1">'/{p}'</span><span class="p">,</span>
    <span class="s1">'/a/b'</span><span class="p">,</span>
    <span class="s1">'/a/{p}'</span><span class="p">,</span>
    <span class="s1">'/b/'</span><span class="p">,</span>
    <span class="s1">'/a1{p}/a'</span><span class="p">,</span>
    <span class="s1">'/xx{p}/b'</span><span class="p">,</span>
    <span class="s1">'/x{p}/a'</span><span class="p">,</span>
    <span class="s1">'/x{p}/b'</span><span class="p">,</span>
    <span class="s1">'/y{p}/b'</span><span class="p">,</span>
    <span class="s1">'/{p}xx/b'</span><span class="p">,</span>
    <span class="s1">'/{p}x/b'</span><span class="p">,</span>
    <span class="s1">'/{p}y/b'</span><span class="p">,</span>
    <span class="s1">'/a/b/c'</span><span class="p">,</span>
    <span class="s1">'/a/b/{p}'</span><span class="p">,</span>
    <span class="s1">'/a/d{p}c/b'</span><span class="p">,</span>
    <span class="s1">'/a/d{p}/b'</span><span class="p">,</span>
    <span class="s1">'/a/{p}d/b'</span><span class="p">,</span>
    <span class="s1">'/a/{p}/b'</span><span class="p">,</span>
    <span class="s1">'/a/{p}/c'</span><span class="p">,</span>
    <span class="s1">'/a/{p*2}'</span><span class="p">,</span>
    <span class="s1">'/a/b/c/d'</span><span class="p">,</span>
    <span class="s1">'/a/b/{p*2}'</span><span class="p">,</span>
    <span class="s1">'/a/{p}/b/{x}'</span><span class="p">,</span>
    <span class="s1">'/{p*5}'</span><span class="p">,</span>
    <span class="s1">'/a/b/{p*}'</span><span class="p">,</span>
    <span class="s1">'/{a}/b/{p*}'</span><span class="p">,</span>
    <span class="s1">'/{p*}'</span>
<span class="p">];</span>
</pre></div>

<p><strong>Path parameters</strong></p>

<p>Parameterized paths are processed by matching the named parameters to the content of the incoming request path at that path segment. For example, '/book/{id}/cover' will match '/book/123/cover' and <code>request.params.id</code> will be set to <code>'123'</code>. Each path segment (everything between the opening '/' and the closing '/' unless it is the end of the path) can only include one named parameter. A parameter can cover the entire segment ('/{param}') or part of the segment ('/file.{ext}').</p>

<p>An optional '?' suffix following the parameter name indicates an optional parameter (only allowed if the parameter is at the ends of the path or only covers part of the segment as in '/a{param?}/b'). For example, the route '/book/{id?}' matches '/book/' with the value of <code>request.params.id</code> set to an empty string <code>''</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">getAlbum</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'You asked for '</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">song</span> <span class="o">?</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">song</span> <span class="o">+</span> <span class="s1">' from '</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)</span> <span class="o">+</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">album</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">'/{album}/{song?}'</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="nx">getAlbum</span>
<span class="p">});</span>
</pre></div>

<p>In addition to the optional <code>?</code> suffix, a parameter name can also specify the number of matching segments using the <code>*</code> suffix, followed by a number greater than 1. If the number of expected parts can be anything, then use <code>*</code> without a number (matching any number of segments can only be used in the last path segment).</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">getPerson</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">nameParts</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
    <span class="nx">reply</span><span class="p">({</span> <span class="nx">first</span><span class="o">:</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">last</span><span class="o">:</span> <span class="nx">nameParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">});</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">'/person/{name*2}'</span><span class="p">,</span>   <span class="c1">// Matches '/person/john/doe'</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">handler</span><span class="o">:</span> <span class="nx">getPerson</span>
<span class="p">});</span>
</pre></div>

<p><strong>Route handler</strong></p>

<p>When a route is matched against an incoming request, the route handler is called and passed a reference to the <code>request</code> object. The handler method must call <code>reply()</code> or one of its sub-methods to return control back to the router.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'success'</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p><strong>Route preprocessing</strong></p>

<p>It is often necessary to perform prerequisite actions before the handler is called (e.g. load required reference data from a database). The route <code>pre</code> option allows defining such pre-handler methods. The methods are called in order. If the pre array contains another array, those methods are called in parallel.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">pre1</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Hello'</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">pre2</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'World'</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">pre3</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m1</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m2</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="nx">config</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">pre</span> <span class="o">:</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="c1">// m1 and m2 executed in parallel</span>
                <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">:</span> <span class="nx">pre1</span><span class="p">,</span>
                    <span class="nx">assign</span> <span class="o">:</span> <span class="s1">'m1'</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="nx">method</span> <span class="o">:</span> <span class="nx">pre2</span><span class="p">,</span>
                    <span class="nx">assign</span> <span class="o">:</span> <span class="s1">'m2'</span>
                <span class="p">}</span>
            <span class="p">],</span> <span class="p">{</span>
                <span class="nx">method</span> <span class="o">:</span> <span class="nx">pre3</span><span class="p">,</span>
                <span class="nx">assign</span> <span class="o">:</span> <span class="s1">'m3'</span>
            <span class="p">},</span>
        <span class="p">],</span>
        <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">reply</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">pre</span><span class="p">.</span><span class="nx">m3</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><strong>Route not found</strong></p>

<p>If the application needs to override the default Not Found (404) error response, it can add a catch-all route for a specific method or all methods. Only one catch-all route can be defined per server instance.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">Server</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">reply</span><span class="p">(</span><span class="s1">'The page was not found'</span><span class="p">).</span><span class="nx">code</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">'*'</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">'/{p*}'</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">handler</span> <span class="p">});</span>
</pre></div>

<p><strong>Array of routes</strong></p>

<p>The server.route method may also take an array of objects containing the three required key/value pairs:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">([</span>
    <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">'/status'</span><span class="p">,</span> <span class="nx">handler</span><span class="o">:</span> <span class="nx">status</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">method</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">'/user'</span><span class="p">,</span> <span class="nx">config</span><span class="o">:</span> <span class="nx">user</span> <span class="p">}</span>
<span class="p">]);</span>
</pre></div>

<p><strong>Request lifecycle</strong></p>

<p>Each incoming request passes through a pre-defined set of steps, along with optional extensions:</p>

<pre><code>'onRequest' extension point
Lookup route using request path
Parse cookies
'onPreAuth' extension point
Authenticate request
Read and parse payload
Authenticate request payload
'onPostAuth' extension point
Validate path parameters
Process query extensions (e.g. JSONP)
Validate query
Validate payload
'onPreHandler' extension point
Route prerequisites
Route handler
'onPostHandler' extension point
Validate response payload
'onPreResponse' extension point
Send response (may emit 'internalError' event)
Emits 'response' event
Wait for tails
Emits 'tail' event
</code></pre>

<h3>Default Configuration for our App</h3>

<p>In this book, we will assume the following in /etc/nginx/include/nodejs-proxy and it is up to you if you would like to change it.</p>

<ul class="task-list">
<li>default folder for static files - /var/www</li>
<li>default path name for static files - [IP_address]/static (Example: <a href="http://192.168.56.101/static">http://192.168.56.101/static</a>)</li>
<li>port binding for our sample Node app - 8080</li>
<li>default folder for our Node app - /root/myapp</li>
<li>default js file for our Node app - index.js</li>
<li>default path name for our Node app - [IP_address]/app (Example: <a href="http://192.168.56.101/app">http://192.168.56.101/app</a>)</li>
<li>defauly MySQL database name - dbapp</li>
</ul><pre><code>access_log /var/log/nginx/nodejs.access.log;
error_log /var/log/nginx/nodejs.error.log;

location /static/ {
  alias /var/www/;
  autoindex off;
}

location /app/ {
  proxy_pass http://127.0.0.1:8080/;
}

location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;

    proxy_pass http://127.0.0.1:8000/;
    proxy_redirect off;
    proxy_buffering off;
}
</code></pre>

<h3>Token-based User Authentication</h3>

<p>HTTP is stateless. To track a Web browser session, <a href="http://en.wikipedia.org/wiki/HTTP_cookie">HTTP cookies</a> (or simply cookies) have been invented and the rest is history (read: <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a> and <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">cross-site request forgery</a>). Read Jesse Hallett's post why <a href="http://sitr.us/2011/08/26/cookies-are-bad-for-you.html">cookies are bad for you</a>. Historically, cookies are being used to track, authenticate and authorize those user sessions. But cookies are vulnerable to XSS and XSRF. In order to protect the API for each request, we are going to use JSON Web Token (JWT, pronounced as "jot"), not cookies.</p>

<p>In the context of Web applications, this is the user session workflow:</p>

<blockquote>
<p>Note: Client means user browser, server means your server API</p>
</blockquote>

<ol class="task-list">
<li>User login with credentials (username/email address, password) at secure page (https)</li>
<li>Your server authenticates the client credentials</li>
<li>If ok, give access to client with token. If not, error message then go to login page</li>
<li>Client carries token for subsequent server request</li>
<li>Server validates token. If invalid, error message then go to login page</li>
<li>Go back to step 4, ad infinitum</li>
</ol><p>Here are some guidelines to remember when using JSON Web Token (courtesy of <a href="https://auth0.com/blog/2014/01/27/ten-things-you-should-know-about-tokens-and-cookies/">Auth0</a>).</p>

<ul class="task-list">
<li>Tokens need to be stored somewhere on the client side (sessionStorage, localStorage or even cookie)</li>
<li>Tokens can have expiration and set by the server</li>
<li>Tokens get sent on every request (like cookies)</li>
<li>Tokens can store some metadata for your session needs (e.g. your app version)</li>
<li>You can encrypt confidential metadata (like SSN) before including it in the token</li>
<li>Tokens are URL-safe, meaning they can be used in query string parameters (courtesy: <a href="http://www.sitepoint.com/using-json-web-tokens-node-js/">SitePoint</a>)</li>
</ul><p><strong>Principle of JSON Web Token</strong></p>

<p>The principle behind JWT is <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash function</a>. The basic idea is that you can hash any arbitrary data along with a secret key. For example, in the user login use case, once we have authenticated the username and password, we can generate a new token based on expiration time, <a href="http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html">claims set</a> and other application-specific data you want to include in the token. </p>

<blockquote>
<p>It is important to note that you sign a token only once after the user authentication is complete. Then, that token can be passed back and forth between your client and server during the allowed time.</p>
</blockquote>

<p>In short, once we get past the username/password verification, we will let the user attach a "security pass" in the form of JSON string or token in place of the username/password for every API call. That security pass may have additional metadata such as expiration, issuer, audience, subject and others.</p>

<p><strong>Expiration Window</strong></p>

<p>JWT can have an expiration and it depends on your application needs.</p>

<p>For example, consider these use cases:</p>

<ul class="task-list">
<li>15-minute expiration for transaction processing like credit cards etc (token is stored in sessionStorage) - the smaller the time window for high-value transactions, the better</li>
<li>[insert-number-of-days] expiration for apps with Remember Me feature (token is stored in localStorage or cookie) - in this case, check if the user still exists or access hasn't been revoked or whatever makes sense for your application (courtesy: <a href="https://auth0.com/blog/2014/01/27/ten-things-you-should-know-about-tokens-and-cookies/">Auth0</a>)</li>
<li>[insert-number-of-minutes] expiration - For business apps whose users login for at least 30 minutes to at most 8 hours, then consider the maximum time expiration, but your mileage may vary.</li>
</ul><h3>jsonwebtoken Library</h3>

<p>For our JWT Node library, we are going to use <a href="https://www.npmjs.org/package/jsonwebtoken">jsonwebtoken</a>.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">jsonwebtoken</span>
</pre></div>

<blockquote>
<p>jwt.sign(payload, secretOrPrivateKey, options)**</p>
</blockquote>

<p>(Synchronous) Returns the JsonWebToken as string</p>

<ul class="task-list">
<li><p>payload could be an literal, buffer or string</p></li>
<li><p>secretOrPrivateKey is a string or buffer containing either the secret for HMAC algorithms, or the PEM encoded private key for RSA and ECDSA.</p></li>
<li><p>options - an object with the following keys: algorithm (default: HS256), expiresInMinutes, audience, subject, issuer</p></li>
</ul><p>If payload is not a buffer or a string, it will be coerced into a string using JSON.stringify.</p>

<p>If any expiresInMinutes, audience, subject, issuer are not provided, there is no default. The jwt generated won't include those properties in the payload.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// sign with default (HMAC SHA256)</span>
<span class="kd">var</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jsonwebtoken'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span> <span class="p">},</span> <span class="s1">'shhhhh'</span><span class="p">);</span>

<span class="c1">// sign with RSA SHA256</span>
<span class="kd">var</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'private.key'</span><span class="p">);</span>  <span class="c1">// get private key</span>
<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span> <span class="p">},</span> <span class="nx">cert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">algorithm</span><span class="o">:</span> <span class="s1">'RS256'</span><span class="p">});</span>
</pre></div>

<blockquote>
<p>jwt.verify(token, secretOrPublicKey, options, callback)</p>
</blockquote>

<p>(Synchronous with callback) Returns the payload decoded if the signature (and optionally expiration, audience, issuer) are valid. If not, it will return the error.</p>

<ul class="task-list">
<li><p>token is the JsonWebToken string</p></li>
<li><p>secretOrPublicKey is a string or buffer containing either the secret for HMAC algorithms, or the PEM encoded public key for RSA and ECDSA.</p></li>
<li><p>options - an object with the following keys: audience and issuer</p></li>
</ul><div class="highlight highlight-javascript"><pre><span class="c1">// verify a token symmetric</span>
<span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="s1">'shhhhh'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">decoded</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span> <span class="c1">// bar</span>
<span class="p">});</span>

<span class="c1">// invalid token</span>
<span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="s1">'wrong-secret'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// err </span>
  <span class="c1">// decoded undefined</span>
<span class="p">});</span>

<span class="c1">// verify a token asymmetric</span>
<span class="kd">var</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'public.pem'</span><span class="p">);</span>  <span class="c1">// get public key</span>
<span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">cert</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">decoded</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span> <span class="c1">// bar</span>
<span class="p">});</span>

<span class="c1">// verify audience</span>
<span class="kd">var</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'public.pem'</span><span class="p">);</span>  <span class="c1">// get public key</span>
<span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">cert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">audience</span><span class="o">:</span> <span class="s1">'urn:foo'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// if audience mismatch, err == invalid audience</span>
<span class="p">});</span>

<span class="c1">// verify issuer</span>
<span class="kd">var</span> <span class="nx">cert</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'public.pem'</span><span class="p">);</span>  <span class="c1">// get public key</span>
<span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">cert</span><span class="p">,</span> <span class="p">{</span> <span class="nx">audience</span><span class="o">:</span> <span class="s1">'urn:foo'</span><span class="p">,</span> <span class="nx">issuer</span><span class="o">:</span> <span class="s1">'urn:issuer'</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// if issuer mismatch, err == invalid issuer</span>
<span class="p">});</span>
</pre></div>

<blockquote>
<p>jwt.decode(token)</p>
</blockquote>

<p>(Synchronous) Returns the decoded payload without verifying if the signature is valid.</p>

<p>token is the JsonWebToken string</p>

<p>Example</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// get the decoded payload ignoring signature, no secretOrPrivateKey needed</span>
<span class="kd">var</span> <span class="nx">decoded</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</pre></div>

<h2>Part V - Database Development</h2>

<h3>Database Schema</h3>

<p>Our sample application is a micro version of Virtual Terminal (VT). That is, we will assume that you are a platform that accepts US debit/credit cards for processing on behalf of your customers, takes a small percentage out of every transaction and then deposits the amount withdrawn by your customers on their VT account. This Web application is deliberately designed to be simple so as not to deluge you with unnecessary details.</p>

<p>Our database schema has been generated courtesy of the browser-based <a href="http://code.google.com/p/wwwsqldesigner/">wwwsqldesigner</a>.</p>

<ul class="task-list">
<li>Table: Acct (Holds the account details of customers)</li>
</ul><div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Acct</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">BirthMonth</span><span class="o">`</span> <span class="n">TINYINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">BirthDay</span><span class="o">`</span> <span class="n">TINYINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">BirthYear</span><span class="o">`</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">FirstName</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">LastName</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Street</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">City</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="k">State</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ZipCode</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Password</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Salt</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Email</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">BankAcct</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">RoutingNumber</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>Table: Transaction (Holds card/withdrawal transactions and running balance per account)</li>
</ul><div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">Transaction</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">IDAcct</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Dt</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Amount</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Balance</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>Table: TransactionDetails (Holds the card details from parent Transaction table)</li>
</ul><div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">TransactionDetails</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">IDTxn</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CustFirstname</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CustLastname</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CardType</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CardNumber</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ExpiryMonth</span><span class="o">`</span> <span class="n">TINYINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">ExpiryYear</span><span class="o">`</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Cvv</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Fee</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">NetAmount</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<ul class="task-list">
<li>Table: FeeSchedule (Holds the percentage fee based on amount range)</li>
</ul><div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">FeeSchedule</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">CardType</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="k">Alias</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">Percentage</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">MinAmtRange</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">MaxAmtRange</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<h3>MySQL Workbench</h3>

<p>To connect to MySQL in our Node VM, we can use <a href="http://www.mysql.com/products/workbench/">MySQL Workbench</a>. Here are the connection details:</p>

<ul class="task-list">
<li><p>Connection Method: Standard TCP/IP over SSH</p></li>
<li><p>SSH Hostname: 192.168.0.101 (or your IPaddress)</p></li>
<li><p>SSH Username: root</p></li>
<li><p>MySQL Hostname: localhost</p></li>
<li><p>MySQL Server Port: 3306</p></li>
<li><p>Username: root</p></li>
</ul><h3>Create Database Tables</h3>

<div class="highlight highlight-sql"><pre><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">dbapp</span><span class="p">;</span>
</pre></div>

<pre><code>USE dbapp;
</code></pre>

<p>Then execute all the SQL statements in the Database Schema section.</p>

<h3>Insert Data</h3>

<div class="highlight highlight-sql"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Acct</span><span class="p">(</span><span class="n">BirthMonth</span><span class="p">,</span> <span class="n">BirthDay</span><span class="p">,</span> <span class="n">BirthYear</span><span class="p">,</span> <span class="n">FirstName</span><span class="p">,</span> 
<span class="n">LastName</span><span class="p">,</span> <span class="n">Street</span><span class="p">,</span> <span class="n">City</span><span class="p">,</span> <span class="k">State</span><span class="p">,</span> <span class="n">ZipCode</span><span class="p">,</span> <span class="n">Password</span><span class="p">,</span> 
<span class="n">Salt</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">BankAcct</span><span class="p">,</span> <span class="n">RoutingNumber</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1980</span><span class="p">,</span> <span class="s1">'Chelsea'</span><span class="p">,</span> <span class="s1">'Maine'</span><span class="p">,</span> 
<span class="s1">'143 Ross Lane'</span><span class="p">,</span> <span class="s1">'San Jose'</span><span class="p">,</span> <span class="s1">'CA'</span><span class="p">,</span> <span class="s1">'95132'</span><span class="p">,</span> <span class="s1">'syhyhs2sOhComRHxG6aP3vcCSXW5lQVDdvrWQ6YWj_c'</span><span class="p">,</span> 
<span class="s1">'2khs8s'</span><span class="p">,</span> <span class="s1">'chelsea@foo.com'</span><span class="p">,</span> <span class="s1">'123456789012'</span><span class="p">,</span> <span class="s1">'123456789'</span><span class="p">)</span>
</pre></div>

<h3>Retrieve Data with Node</h3>

<div class="highlight highlight-javascript"><pre><span class="c1">//sql-query.js</span>

<span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
        <span class="s2">"host"</span> <span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">:</span> <span class="s2">"YourPaSsWordHere"</span><span class="p">,</span>
        <span class="s2">"database"</span> <span class="o">:</span> <span class="s2">"dbapp"</span>
    <span class="p">});</span>
<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM Acct"</span><span class="p">;</span>
    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>

</pre></div>

<pre><code>root@nodejs ~/myapp# hotnode sql-query
hotnode node process restarted
[]
hotnode sql-query.js has been changed
hotnode node process restarted
</code></pre>

<p>Output:</p>

<div class="highlight highlight-javascript"><pre><span class="p">[</span> <span class="p">{</span> <span class="nx">ID</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="nx">BirthMonth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="nx">BirthDay</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="nx">BirthYear</span><span class="o">:</span> <span class="mi">1980</span><span class="p">,</span>
<span class="nx">FirstName</span><span class="o">:</span> <span class="s1">'Chelsea'</span><span class="p">,</span>
<span class="nx">LastName</span><span class="o">:</span> <span class="s1">'Maine'</span><span class="p">,</span>
<span class="nx">Street</span><span class="o">:</span> <span class="s1">'143 Ross Lane'</span><span class="p">,</span>
<span class="nx">City</span><span class="o">:</span> <span class="s1">'San Jose'</span><span class="p">,</span>
<span class="nx">State</span><span class="o">:</span> <span class="s1">'CA'</span><span class="p">,</span>
<span class="nx">ZipCode</span><span class="o">:</span> <span class="s1">'95132'</span><span class="p">,</span>
<span class="nx">Password</span><span class="o">:</span> <span class="s1">'syhyhs2sOhComRHxG6aP3vcCSXW5lQVDdvrWQ6YWj_c'</span><span class="p">,</span>
<span class="nx">Salt</span><span class="o">:</span> <span class="s1">'2khs8s'</span><span class="p">,</span>
<span class="nx">Email</span><span class="o">:</span> <span class="s1">'chelsea@foo.com'</span><span class="p">,</span>
<span class="nx">BankAcct</span><span class="o">:</span> <span class="s1">'123456789012'</span><span class="p">,</span>
<span class="nx">RoutingNumber</span><span class="o">:</span> <span class="s1">'123456789'</span> <span class="p">}</span> <span class="p">]</span> 
</pre></div>

<h3>Node-mysql Overview</h3>

<p>Node-mysql is a Node.js driver for MySQL. It is written in JavaScript, does not require compiling, and is 100% MIT licensed. The following is courtesy of node-mysql documentation.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
  <span class="nx">host</span>     <span class="o">:</span> <span class="s1">'localhost'</span><span class="p">,</span>
  <span class="nx">user</span>     <span class="o">:</span> <span class="s1">'me'</span><span class="p">,</span>
  <span class="nx">password</span> <span class="o">:</span> <span class="s1">'secret'</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1 + 1 AS solution'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'The solution is: '</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">solution</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</pre></div>

<p>From this example, you can learn the following:</p>

<ul class="task-list">
<li>Every method you invoke on a connection is queued and executed in sequence.</li>
<li>Closing the connection is done using end() which makes sure all remaining queries are executed before sending a quit packet to the MySQL server.</li>
</ul><p><strong>Establishing Connection</strong></p>

<p>The recommended way to establish a connection is this:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
  <span class="nx">host</span>     <span class="o">:</span> <span class="s1">'example.org'</span><span class="p">,</span>
  <span class="nx">user</span>     <span class="o">:</span> <span class="s1">'bob'</span><span class="p">,</span>
  <span class="nx">password</span> <span class="o">:</span> <span class="s1">'secret'</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'error connecting: '</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'connected as id '</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">threadId</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>However, a connection can also be implicitly established by invoking a query:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">(...);</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// connected! (unless `err` is set)</span>
<span class="p">});</span>
</pre></div>

<p>Depending on how you like to handle your errors, either method may be appropriate. Any type of connection error (handshake or network) is considered a fatal error, see the Error Handling section for more information.</p>

<p><strong>Terminating Connection</strong></p>

<p>There are two ways to end a connection. Terminating a connection gracefully is done by calling the end() method:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// The connection is terminated now</span>
<span class="p">});</span>
</pre></div>

<p>This will make sure all previously enqueued queries are still before sending a COM_QUIT packet to the MySQL server. If a fatal error occurs before the COM_QUIT packet can be sent, an err argument will be provided to the callback, but the connection will be terminated regardless of that.</p>

<p>An alternative way to end the connection is to call the destroy() method. This will cause an immediate termination of the underlying socket. Additionally destroy() guarantees that no more events or callbacks will be triggered for the connection.</p>

<p><strong>Pooling Connection</strong></p>

<p>Use pool directly.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
  <span class="nx">connectionLimit</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nx">host</span>            <span class="o">:</span> <span class="s1">'example.org'</span><span class="p">,</span>
  <span class="nx">user</span>            <span class="o">:</span> <span class="s1">'bob'</span><span class="p">,</span>
  <span class="nx">password</span>        <span class="o">:</span> <span class="s1">'secret'</span>
<span class="p">});</span>

<span class="nx">pool</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1 + 1 AS solution'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'The solution is: '</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">solution</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Connections can be pooled to ease sharing a single connection, or managing multiple connections.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
  <span class="nx">host</span>     <span class="o">:</span> <span class="s1">'example.org'</span><span class="p">,</span>
  <span class="nx">user</span>     <span class="o">:</span> <span class="s1">'bob'</span><span class="p">,</span>
  <span class="nx">password</span> <span class="o">:</span> <span class="s1">'secret'</span>
<span class="p">});</span>

<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// connected! (unless `err` is set)</span>
<span class="p">});</span>
</pre></div>

<p>If you need to set session variables on the connection before it gets used, you can listen to the connection event.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">pool</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'connection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SET SESSION auto_increment_increment=1'</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>

<p>When you are done with a connection, just call connection.release() and the connection will return to the pool, ready to be used again by someone else.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pool</span>  <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">(...);</span>

<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Use the connection</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span> <span class="s1">'SELECT something FROM sometable'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// And done with the connection.</span>
    <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>

    <span class="c1">// Don't use the connection here, it has been returned to the pool.</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>If you would like to close the connection and remove it from the pool, use connection.destroy() instead. The pool will create a new connection the next time one is needed.</p>

<p>Connections are lazily created by the pool. If you configure the pool to allow up to 100 connections, but only ever use 5 simultaneously, only 5 connections will be made. Connections are also cycled round-robin style, with connections being taken from the top of the pool and returning to the bottom.</p>

<p>When a previous connection is retrieved from the pool, a ping packet is sent to the server to check if the connection is still good.</p>

<p><strong>Pool options</strong></p>

<p>Pools accept all the same options as a connection. When creating a new connection, the options are simply passed to the connection constructor. In addition to those options pools accept a few extras:</p>

<ul class="task-list">
<li><p>acquireTimeout: The milliseconds before a timeout occurs during the connection acquisition. This is slightly different from connectTimeout, because acquiring a pool connection does not always involve making a connection. (Default: 10 seconds)</p></li>
<li><p>waitForConnections: Determines the pool's action when no connections are available and the limit has been reached. If true, the pool will queue the connection request and call it when one becomes available. If false, the pool will immediately call back with an error. (Default: true)</p></li>
<li><p>connectionLimit: The maximum number of connections to create at once. (Default: 10)</p></li>
<li><p>queueLimit: The maximum number of connection requests the pool will queue before returning an error from getConnection. If set to 0, there is no limit to the number of queued connection requests. (Default: 0)</p></li>
</ul><p><strong>Server Disconnects</strong></p>

<p>You may lose the connection to a MySQL server due to network problems, the server timing you out, the server being restarted, or crashing. All of these events are considered fatal errors, and will have the err.code = 'PROTOCOL_CONNECTION_LOST'. See the Error Handling section for more information.</p>

<p>Re-connecting a connection is done by establishing a new connection. Once terminated, an existing connection object cannot be re-connected by design.</p>

<p>With Pool, disconnected connections will be removed from the pool freeing up space for a new connection to be created on the next getConnection call.</p>

<p><strong>Escaping query values</strong></p>

<p>In order to avoid SQL Injection attacks, you should always escape any user provided data before using it inside a SQL query. You can do so using the connection.escape() or pool.escape() methods:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="s1">'some user provided value'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">sql</span>    <span class="o">=</span> <span class="s1">'SELECT * FROM users WHERE id = '</span> <span class="o">+</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>

<p>Alternatively, you can use ? characters as placeholders for values you would like to have escaped like this:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT * FROM users WHERE id = ?'</span><span class="p">,</span> <span class="p">[</span><span class="nx">userId</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
</pre></div>

<p>This looks similar to prepared statements in MySQL, however it really just uses the same connection.escape() method internally.</p>

<p>Caution This also differs from prepared statements in that all ? are replaced, even those contained in comments and strings.</p>

<p>Different value types are escaped differently, here is how:</p>

<ul class="task-list">
<li><p>Numbers are left untouched</p></li>
<li><p>Booleans are converted to true / false strings</p></li>
<li><p>Date objects are converted to 'YYYY-mm-dd HH:ii:ss' strings</p></li>
<li><p>Buffers are converted to hex strings, e.g. X'0fa5'</p></li>
<li><p>Strings are safely escaped</p></li>
<li><p>Arrays are turned into list, e.g. ['a', 'b'] turns into 'a', 'b'</p></li>
<li><p>Nested arrays are turned into grouped lists (for bulk inserts), e.g. [['a', 'b'], ['c', 'd']] turns into ('a', 'b'), ('c', 'd')</p></li>
<li><p>Objects are turned into key = 'val' pairs. Nested objects are cast to strings.</p></li>
<li><p>undefined / null are converted to NULL</p></li>
<li><p>NaN / Infinity are left as-is. MySQL does not support these, and trying to insert them as values will trigger MySQL errors until they implement support.</p></li>
</ul><p>If you paid attention, you may have noticed that this escaping allows you to do neat things like this:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">post</span>  <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello MySQL'</span><span class="p">};</span>
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET ?'</span><span class="p">,</span> <span class="nx">post</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Neat!</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">sql</span><span class="p">);</span> <span class="c1">// INSERT INTO posts SET `id` = 1, `title` = 'Hello MySQL'</span>
</pre></div>

<p><strong>Preparing Queries</strong></p>

<p>You can use mysql.format to prepare a query with multiple insertion points, utilizing the proper escaping for ids and values. A simple example of this follows:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM ?? WHERE ?? = ?"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">inserts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'id'</span><span class="p">,</span> <span class="nx">userId</span><span class="p">];</span>
<span class="nx">sql</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">inserts</span><span class="p">);</span>
</pre></div>

<p>Following this you then have a valid, escaped query that you can then send to the database safely. This is useful if you are looking to prepare the query before actually sending it to the database. As mysql.format is exposed from SqlString.format you also have the option (but are not required) to pass in stringifyObject and timezone, allowing you provide a custom means of turning objects into strings, as well as a location-specific/timezone-aware Date.</p>

<p><strong>Getting the id of an inserted row</strong></p>

<p>If you are inserting a row into a table with an auto increment primary key, you can retrieve the insert id like this:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET ?'</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">'test'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>When dealing with big numbers (above JavaScript Number precision limit), you should consider enabling supportBigNumbers option to be able to read the insert id as a string, otherwise it will throw.</p>

<p>This option is also required when fetching big numbers from the database, otherwise you will get values rounded to hundreds or thousands due to the precision limit.</p>

<p><strong>Executing queries in parallel</strong></p>

<p>The MySQL protocol is sequential, this means that you need multiple connections to execute queries in parallel. You can use a Pool to manage connections, one simple approach is to create one connection per incoming http request.</p>

<p><strong>Transactions</strong></p>

<p>Simple transaction support is available at the connection level:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET title=?'</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
      <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="s1">'Post '</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span> <span class="o">+</span> <span class="s1">' added'</span><span class="p">;</span>

    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO log SET data=?'</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>  
      <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> 
          <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success!'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<blockquote>
<p>Please note that beginTransaction(), commit() and rollback() are simply convenience functions that execute the START TRANSACTION, COMMIT, and ROLLBACK commands respectively. It is important to understand that many commands in MySQL can cause an implicit commit, as described in the MySQL documentation.</p>
</blockquote>

<p><strong>Timeouts</strong></p>

<p>Every operation takes an optional inactivity timeout option. This allows you to specify appropriate timeouts for operations. It is important to note that these timeouts are not part of the MySQL protocol, and rather timeout operations through the client. This means that when a timeout is reached, the connection it occurred on will be destroyed and no further operations can be performed.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// Kill query after 60s</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span><span class="nx">sql</span><span class="o">:</span> <span class="s1">'SELECT COUNT(*) AS count FROM big_table'</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mi">60000</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">'PROTOCOL_SEQUENCE_TIMEOUT'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'too long to count table rows!'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">count</span> <span class="o">+</span> <span class="s1">' rows'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p><strong>Error handling</strong></p>

<p>This module comes with a consistent approach to error handling that you should review carefully in order to write solid applications.</p>

<p>All errors created by this module are instances of the JavaScript Error object. Additionally they come with two properties:</p>

<ul class="task-list">
<li><p>err.code: Either a MySQL server error (e.g. 'ER_ACCESS_DENIED_ERROR'), a node.js error (e.g. 'ECONNREFUSED') or an internal error (e.g. 'PROTOCOL_CONNECTION_LOST').</p></li>
<li><p>err.fatal: Boolean, indicating if this error is terminal to the connection object.</p></li>
</ul><p>Fatal errors are propagated to all pending callbacks. In the example below, a fatal error is triggered by trying to connect to an invalid port. Therefore the error object is propagated to both pending callbacks:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">).</span><span class="nx">createConnection</span><span class="p">({</span>
  <span class="nx">port</span><span class="o">:</span> <span class="mi">84943</span><span class="p">,</span> <span class="c1">// WRONG PORT</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span> <span class="c1">// 'ECONNREFUSED'</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">fatal</span><span class="p">);</span> <span class="c1">// true</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span> <span class="c1">// 'ECONNREFUSED'</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">fatal</span><span class="p">);</span> <span class="c1">// true</span>
<span class="p">});</span>
</pre></div>

<p>Normal errors however are only delegated to the callback they belong to. So in the example below, only the first callback receives an error, the second query works as expected:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'USE name_of_db_that_does_not_exist'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span> <span class="c1">// 'ER_BAD_DB_ERROR'</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT 1'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="c1">// null</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// 1</span>
<span class="p">});</span>
</pre></div>

<p>Last but not least: If a fatal errors occurs and there are no pending callbacks, or a normal error occurs which has no callback belonging to it, the error is emitted as an 'error' event on the connection object. This is demonstrated in the example below:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span> <span class="c1">// 'ER_BAD_DB_ERROR'</span>
<span class="p">});</span>

<span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'USE name_of_db_that_does_not_exist'</span><span class="p">);</span>
</pre></div>

<blockquote>
<p>Note: 'error' are special in node. If they occur without an attached listener, a stack trace is printed and your process is killed.</p>
</blockquote>

<p><strong>Exception Safety</strong></p>

<p>The node-mysql module is exception safe. That means you can continue to use it, even if one of your callback functions throws an error which you're catching using 'uncaughtException' or a domain.</p>

<h2>Part VI. Putting it all Together</h2>

<h3>Debugging with Promise-based Programming</h3>

<p>Throughout this book, I will show you a mix of continuation-passing style (CPS) and promise-based programming (PBP). For code that are short and relatively simple, you may use CPS but as it gets more complicated, I prefer using PBP (in particular, using WhenJS).</p>

<p>For our sample Web application, there are only two pages: the main page and the account page. The account page is deliberately unfinished to accommodate exercising your knowledge in case you don't have a real app yet in mind.</p>

<blockquote>
<p>Note: Since I have a particular promise-based library (WhenJS) being used in this book, I want to forewarn you regarding debugging. Do not catch errors for the moment (you may use console.log). Let Node show you the stack trace. Catch the syntax errors first, the semantic errors later. When you are done, put the catch error handler back to your code.</p>
</blockquote>

<p>The code below disables the catch handler so Node will display a stack trace for every error found.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//by convention, returns a JSON object with two properties: success and msg</span>
    <span class="kd">function</span> <span class="nx">returnSuccess</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">token</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">returnError</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">msg</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//control logic</span>

    <span class="kd">var</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pswd</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>

    <span class="nx">deferPoolGetConnection</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">pswd</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">getSalt</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">checkEmailAndPswd</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">generateToken</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">returnSuccess</span><span class="p">)</span>
    <span class="c1">//.catch (returnError) //catches all errors anywhere in the chain</span>

<span class="p">}</span>
</pre></div>

<h3>Packages Used</h3>

<p><strong>Global packages</strong></p>

<div class="highlight highlight-javascript"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">packagename</span> <span class="o">-</span><span class="nx">g</span>
</pre></div>

<ul class="task-list">
<li>n</li>
<li>hotnode</li>
<li>browserify</li>
</ul><p><strong>Local packages</strong></p>

<p>Since we have only one Node app sample in this book, we will install everything from the root CLI so our local packages will be installed under /root. In practice, if you have two or more apps and you don't want package versions to conflict with one another, you need to issue the npm install command at a specific designated folder. </p>

<p>For example, in our case, all scripts are under </p>

<pre><code>/root/myapp
</code></pre>

<p>So if we change to that folder and issue npm install packagename,</p>

<pre><code>root@nodejs ~# cd myapp
root@nodejs ~/myapp# npm install packagename
</code></pre>

<p>all our local packages will be installed under</p>

<pre><code>/root/myapp/node_modules
</code></pre>

<p>So if we have a different app under /root/billing and issue npm install packagename from there, our local packages will be installed under</p>

<pre><code>/root/billing/node_modules
</code></pre>

<p>That is NPM's way of isolating package versions from one folder to another. If a package is not found under node_modules folder of current directory, it will work its way up until it reaches the root folder (in our case, it is  /root/node_modules).</p>

<p>In this book, I have included a package.json.</p>

<div class="highlight highlight-javascript"><pre><span class="p">{</span>
  <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"myapp"</span><span class="p">,</span>
  <span class="s2">"version"</span><span class="o">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
  <span class="s2">"description"</span><span class="o">:</span> <span class="s2">"Web Development Jumpstart sample app"</span><span class="p">,</span>
  <span class="s2">"dependencies"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"hapi"</span><span class="o">:</span> <span class="s2">"6.2.0"</span><span class="p">,</span>
    <span class="s2">"jsonwebtoken"</span><span class="o">:</span> <span class="s2">"0.4.1"</span><span class="p">,</span>
    <span class="s2">"mysql"</span><span class="o">:</span> <span class="s2">" 2.4.1"</span><span class="p">,</span>
    <span class="s2">"joi"</span><span class="o">:</span> <span class="s2">"4.6.1"</span><span class="p">,</span>
    <span class="s2">"jwa"</span><span class="o">:</span> <span class="s2">"0.0.2"</span><span class="p">,</span>
    <span class="s2">"node-uuid"</span><span class="o">:</span> <span class="s2">"1.4.1"</span><span class="p">,</span>
    <span class="s2">"step"</span><span class="o">:</span> <span class="s2">"0.0.5"</span><span class="p">,</span>
    <span class="s2">"when"</span><span class="o">:</span> <span class="s2">"3.4.3"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>From Webmin, upload that package.json file to /root/myapp and then from the Web Shell, type</p>

<pre><code>cd myapp
npm install
</code></pre>

<p>Node will install all packages for you so need not do it manually. The resulting package location will be at</p>

<pre><code>/root/myapp/node_modules
</code></pre>

<p>Once you are done, you may ignore the subsequent npm install of local packages in this book (that is, those npm install without -g).</p>

<h3>Application Folder Structure</h3>

<p>Our sample application does not impose mandatory folder structure unlike those in client-side or server-side frameworks. However, for consistency, I have made the following folder structure.</p>

<ol class="task-list">
<li><p>For our Node app</p></li>
</ol><ul class="task-list">
<li>/root/myapp/index.js - for our control logic</li>
<li><p>/root/myapp/node_modules/app.js - for our application logic</p></li>
</ul><ol class="task-list">
<li><p>For static files</p></li>
</ol><ul class="task-list">
<li>/var/www - for html, css and js files</li>
</ul><p>Alternatively, you may upload the included zip files using Webmin &gt; Tools &gt; Upload and Download &gt; Upload to Server.</p>

<ul class="task-list">
<li>myapp.zip - upload to /root/myapp</li>
<li>
<a href="http://www.zip">www.zip</a> - upload to /var/www</li>
</ul><h3>Client-side Login Validation</h3>

<blockquote>
<p>Notes: </p>
</blockquote>

<p>Input: email and password<br>
Output: input is validated under business rules (same server-side validation)<br>
Tool: Joi library via Browserify (see Browserify at Part III)</p>

<ul class="task-list">
<li>sign up dialog box - only validates the email and password at the client side, backend code is left as an exercise to the reader. Password is stored as HMAC signature of actual user password appended with randomly-generated "salt" and a secret key (see Change Password section)</li>
<li>valid password - any of alphanumeric and this set of characters [@#$%^&amp;*()], minimum: 7 characters, maximum: 20 characters</li>
</ul><div class="highlight highlight-javascript"><pre><span class="c1">//snippet for sign up validation</span>

<span class="nx">$</span><span class="p">(</span><span class="s2">"#btnSignup"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
            <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>

        <span class="p">}).</span><span class="kd">with</span> <span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span>
        <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtSignupEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtSignupPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s2">"valid email and password!"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>AJAX Demo</h3>

<div class="highlight highlight-javascript"><pre><span class="c1">//Main.html - ajax call to /app which outputs Hello world! on success</span>

<span class="nx">$</span><span class="p">(</span><span class="s2">"#btnLogin"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
            <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>

        <span class="p">}).</span><span class="kd">with</span> <span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span>
        <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//Fadealert.show("valid email and password!");</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span> <span class="o">:</span> <span class="s2">"GET"</span><span class="p">,</span>
                <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app"</span><span class="p">,</span>
                <span class="nx">success</span> <span class="o">:</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>Node script hapi.js</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//hapi.js from "RESTful API with hapi" section</span>
<span class="c1">//cross-reference "Default configuration for our app" section</span>

<span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
<span class="c1">// Handler in top level</span>
<span class="kd">var</span> <span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Hello world!'</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">hello</span>
<span class="p">});</span>
<span class="c1">// Handler in config</span>
<span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">cache</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">expiresIn</span> <span class="o">:</span> <span class="mi">5000</span>
    <span class="p">},</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">({</span>
            <span class="nx">name</span> <span class="o">:</span> <span class="s1">'John'</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/user'</span><span class="p">,</span>
    <span class="nx">config</span> <span class="o">:</span> <span class="nx">user</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Server started at: '</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>When you run our Node script hapi.js </p>

<pre><code>hotnode /root/myapp/hapi
</code></pre>

<p>Output:</p>

<pre><code>hotnode node process restarted
Server started at: http://nodejs:8080 
</code></pre>

<p>Since we configured /app pathname to be listening on port 8080 at our nginx configuration file (see "Default configuration for our app" section in Part IV), nginx will route our AJAX call to /app as a request to our Node script hapi.js since it listens on port 8080. </p>

<blockquote>
<p>Note: we can only run one script per port at a time, otherwise you will get an EADDRINUSE error.</p>
</blockquote>

<p>You should then see "Hello world!" in the fade alert in our login modal box.</p>

<h3>Server-side Input Validation</h3>

<blockquote>
<p>Notes:</p>
</blockquote>

<p><strong>Prerequisite:</strong> client-side input validation (input: email and password)<br><strong>Output:</strong> input is validated under business rules (same client-side validation)<br><strong>Tool:</strong> Joi library</p>

<p>Now, we will create an index.js file at /root/myapp folder that will serve as our main script for the rest of this book.</p>

<ul class="task-list">
<li>Client POST and Hapi payload</li>
</ul><div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#btnLogin"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
            <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>

        <span class="p">}).</span><span class="kd">with</span> <span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span>
        <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//Fadealert.show("valid email and password!");</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
                <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/login"</span><span class="p">,</span>
                <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span>
                    <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                    <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="nx">success</span> <span class="o">:</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>In our jQuery AJAX POST, we passed the data as an object which is then validated by our Node script in its payload. Notice that our Joi validation script is the same in both client and server code.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//index.js</span>

<span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Joi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'joi'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>

<span class="c1">// Handler in top level</span>
<span class="kd">var</span> <span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Hello world!'</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">hello</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Server validated: valid email and password!'</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/login'</span><span class="p">,</span>
    <span class="nx">config</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">handler</span><span class="o">:</span> <span class="nx">login</span><span class="p">,</span> 
        <span class="nx">validate</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">payload</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
                <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Server started at: '</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h3>Login Validation Against Database</h3>

<blockquote>
<p>Notes: Once we get past the server-side input validation of email and password, we can now check if the inputs are existing in our database. </p>
</blockquote>

<p><strong>Prerequisite:</strong> server-side input validation (input: email and password)<br><strong>Process:</strong> after validation is done, get salt and ID of user<br><strong>Output:</strong> Salt and ID of user</p>

<p>Input:</p>

<pre><code>email: chelsea@foo.com
password: k6kd8dj
</code></pre>

<p>In our Acct table, the password <code>k6kd8dj</code> is stored as HMAC signature like this:</p>

<pre><code>syhyhs2sOhComRHxG6aP3vcCSXW5lQVDdvrWQ6YWj_c
</code></pre>

<blockquote>
<p>Code snippet from whenLogin.js</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">deferPoolGetConnection</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">pswd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">dbPool</span><span class="p">();</span>

    <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'pool.getConnection'</span><span class="p">);</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'System error getting database connection!'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">connection</span><span class="p">,</span>
                <span class="nx">email</span> <span class="o">:</span> <span class="nx">email</span><span class="p">,</span>
                <span class="nx">pswd</span> <span class="o">:</span> <span class="nx">pswd</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getSalt</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'SELECT salt FROM Acct WHERE email = ?'</span><span class="p">;</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//internal error, do not broadcast salt to user</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'System error: Get salt from email = '</span> <span class="o">+</span> <span class="nx">email</span><span class="p">);</span>

            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error getting account email: "</span> <span class="o">+</span> <span class="nx">email</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>

            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
                <span class="nx">email</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
                <span class="nx">pswd</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">pswd</span><span class="p">,</span>
                <span class="c1">//results is an array</span>
                <span class="nx">results</span> <span class="o">:</span> <span class="nx">results</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">checkEmailAndPswd</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'checkEmailAndPswd: obj.results.length &lt; 1'</span><span class="p">);</span>

        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Invalid email and/or password'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">pswd</span> <span class="o">+</span> <span class="s1">' email = '</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>

            <span class="c1">//assuming db integrity, we expect only one record as result</span>
            <span class="kd">var</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">salt</span><span class="p">;</span>

            <span class="c1">//password as HMAC</span>
            <span class="c1">//var pswdsignature = hmac.sign(obj.pswd + salt, PSWDSECRET);</span>

            <span class="kd">var</span> <span class="nx">pswdsignature</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">pswd</span><span class="p">;</span>  <span class="c1">//password as clear text</span>

            <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'SELECT ID FROM Acct WHERE email = ? and password = ?'</span><span class="p">;</span>

            <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">pswdsignature</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'checkEmailAndPswd: connection.query'</span><span class="p">);</span>
                    <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'System error on getting account record'</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                        <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
                        <span class="nx">results</span> <span class="o">:</span> <span class="nx">results</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">});</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Database error: Two or more email addresses found'</span><span class="p">);</span>

            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"Error: Multiple duplicate email address found on our system"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Since establishing database connection per API request is expensive, we can make use of connection pooling so that we can easily get one for each database query and release it when we are done. The default connection limit is 10.</p>

<p>Also, we can communicate the error back to the Web app user but for now, we will just make do with console log. </p>

<blockquote>
<p>Note: In practice, we are not going to store the password in clear text. The SQL at "Insert Data" section of Part V is meant to be used as an example. You can go to "Password HMAC" section later in this chapter to see how a password can be stored as a hash with a secret key instead of using encryption.</p>
</blockquote>

<h3>API Authentication - Generate Token</h3>

<blockquote>
<p>Notes: This situation primarily occurs after success login, but it is up to you if you want to generate a new token in a given time interval based on your business rules </p>
</blockquote>

<p><strong>Prerequisite:</strong> Pass the input validation against database (for example: email and password)<br><strong>Process:</strong> Generate token<br><strong>Output:</strong> JSON Web Token</p>

<p>For API authentication, we are going to use JSON Web Token with Node jsonwebtoken library (see Token-based User Authentication section at Part IV).</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//code snippet from whenLogin.js</span>

<span class="kd">function</span> <span class="nx">generateToken</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">results</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// this is the results object</span>
        <span class="c1">// [{ ID : 1 }]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//application error</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Error: Invalid email and/or password'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">// sign with default (HMAC SHA256)</span>
            <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span>
                    <span class="nx">id</span> <span class="o">:</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ID</span> <span class="c1">//ID from Acct table</span>
                <span class="p">},</span> <span class="nx">secret</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">expiresInMinutes</span> <span class="o">:</span> <span class="mi">150</span>
                <span class="p">});</span>

            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Error: Invalid email and/or password'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Sample Token (actual token is one long string):</p>

<pre><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.
eyJmb28iOiJiYXIiLCJpYXQiOjE0MDY1MjIzODMsImV4cCI6MTQwNjUyMzI4M30.
KSnV6rPETB45UZ1weBIaBDVdVfceum2mFMmprdvLE9I
</code></pre>

<h3>API Authentication - Store Token to localStorage</h3>

<blockquote>
<p>Note: This context refers to a situation where after successful login, the server issues a JSON Web Token which the client HTML must store to localStorage since the token needs to be attached for <strong>every</strong> subsequent API call. Note that this also applies in case of forced login if the locally stored token has expired or invalid (of course, assuming the login was successful).</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#btnLogin"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
            <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>

        <span class="p">}).</span><span class="kd">with</span> <span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span>
        <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
                <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/login"</span><span class="p">,</span>
                <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span>
                    <span class="nx">email</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginEmail'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
                    <span class="nx">password</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtLoginPswd'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="nx">success</span> <span class="o">:</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">)</span> <span class="p">{</span>

                        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

                            <span class="c1">//token will be used by acct.html</span>
                            <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

                            <span class="nx">$</span><span class="p">(</span><span class="s1">'#modalLogin'</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="s1">'hide'</span><span class="p">);</span>

                            <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'/static/acct.html'</span><span class="p">,</span> <span class="s2">"_self"</span><span class="p">);</span>
                        <span class="p">}</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">Fadealert</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">'LocalStorage not supported! Upgrade your Web browser'</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>API Authentication - Attach Token</h3>

<blockquote>
<p>Note: This context refers to a situation where you are already validated by the server and you need to call a server API. In this case, you need to read the token stored in localStorage and attach it as well as some optional data to an AJAX call.</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#btnSubmitProfile"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">currentYear</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">FirstName</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">LastName</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Month</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Day</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">31</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Year</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1940</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="nx">currentYear</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">AccountNumber</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">100000000000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">999999999999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">RoutingNumber</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">100000000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">999999999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Street</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">City</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">State</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">ZipCode</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">10000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">99999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
        <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">objData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">FirstName</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPFirstName'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">LastName</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPLastName'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Month</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#cmbPBirthMonth'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Day</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBirthDay'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Year</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBirthYear'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">AccountNumber</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBankAcctNumber'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">RoutingNumber</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPRoutingNumber'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Street</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPStreetAddress'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">City</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPCity'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">State</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#cmbPState'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">ZipCode</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPZipCode'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">objData</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">abortEarly</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">//attach the token</span>
            <span class="nx">objData</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
                <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/postprofile"</span><span class="p">,</span>
                <span class="nx">data</span> <span class="o">:</span> <span class="nx">objData</span><span class="p">,</span>
                <span class="nx">success</span> <span class="o">:</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

                        <span class="c1">//uses underscore library</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' VALUES === '</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="c1">//valid token</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                        <span class="nx">alert</span><span class="p">(</span><span class="s1">'invalid token'</span><span class="p">)</span> <span class="c1">//force to main page</span>

                        <span class="c1">//window.open('/static/main.html',"_self");</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>API Authentication - Verify Token</h3>

<blockquote>
<p>Notes: This context refers to a server API that has been called from the client-side. Every protected API request needs to be authenticated so it must have an attached token. </p>
</blockquote>

<p>JSON Web Token can be attached from the client-side HTML using the following:</p>

<ul class="task-list">
<li>body request in POST</li>
<li>query string - see <a href="http://www.intridea.com/blog/2013/11/7/json-web-token-the-useful-little-standard-you-haven-t-heard-about">Michael Bleigh</a> post</li>
<li>header - see <a href="http://www.sitepoint.com/using-json-web-tokens-node-js/">Lukas White</a> post</li>
</ul><p>In this book, we will use the body request in POST and the JSON Web Token will be referenced in Hapi like so:</p>

<pre><code>request.payload.token
</code></pre>

<blockquote>
<p>Code template courtesy of <a href="https://www.npmjs.org/package/jsonwebtoken">jsonwebtoken</a> library</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="c1">//authenticate every API request</span>
<span class="kd">function</span> <span class="nx">profile</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span>

    <span class="kd">var</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">success</span>

    <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span>
        <span class="nx">success</span> <span class="o">=</span> <span class="nx">decoded</span>
    <span class="p">}</span>

    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">:</span> <span class="s1">'error'</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">//other data you want are stored in payload of JSON Web Token</span>
            <span class="c1">//for example, the userID can be retrieved from the token so you</span>
            <span class="c1">//need not make a database query which is expensive</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">success</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

            <span class="c1">//return the same token</span>
            <span class="nx">token</span> <span class="o">:</span> <span class="nx">token</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>

<h3>Display Data to User Interface</h3>

<blockquote>
<p>Client-side code snippet</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s1">'#hProfile'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">hideAllButOne</span><span class="p">(</span><span class="s2">"#divProfile"</span><span class="p">)</span>

    <span class="c1">//don't forget to attach the token first</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
        <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/getprofile"</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">:</span> <span class="nx">token</span>
        <span class="p">},</span>
        <span class="nx">success</span> <span class="o">:</span>
        <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

                    <span class="c1">//alert(_.keys(obj) + ' VALUES === ' + _.values(obj))</span>

                    <span class="cm">/* this is the results object</span>
<span class="cm">                    [{</span>
<span class="cm">                    ID : 1,</span>
<span class="cm">                    BirthMonth : 1,</span>
<span class="cm">                    BirthDay : 1,</span>
<span class="cm">                    BirthYear : 1980,</span>
<span class="cm">                    FirstName : 'Chelsea',</span>
<span class="cm">                    LastName : 'Maine',</span>
<span class="cm">                    Street : '143 Ross Lane',</span>
<span class="cm">                    City : 'San Jose',</span>
<span class="cm">                    State : 'CA',</span>
<span class="cm">                    ZipCode : '95132',</span>
<span class="cm">                    Password : 'syhyhs2sOhComRHxG6aP3vcCSXW5lQVDdvrWQ6YWj_c',</span>
<span class="cm">                    Salt : '2khs8s',</span>
<span class="cm">                    Email : 'chelsea@foo.com',</span>
<span class="cm">                    BankAcct : '123456789012',</span>
<span class="cm">                    RoutingNumber : '123456789'</span>
<span class="cm">                    }</span>
<span class="cm">                    ]</span>
<span class="cm">                     */</span>

                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPEmail"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Email</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPBalance"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">'0.00'</span><span class="p">)</span> <span class="c1">//hardcoded, zero for now</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPFirstName"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">FirstName</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPStreetAddress"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Street</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPLastName"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">LastName</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPCity"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">City</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPBirthDay"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">BirthDay</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPZipCode"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ZipCode</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPBirthYear"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">BirthYear</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPBankAcctNumber"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">BankAcct</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"#edtPRoutingNumber"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">RoutingNumber</span><span class="p">)</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"select#cmbPBirthMonth"</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">'selectedIndex'</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">BirthMonth</span><span class="p">);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s2">"select#cmbPState"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">State</span><span class="p">);</span>

                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                    <span class="nx">alert</span><span class="p">(</span><span class="s1">'invalid token'</span><span class="p">)</span> <span class="c1">//force to main page</span>

                    <span class="c1">//window.open('/static/main.html',"_self");</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>
</pre></div>

<p>Notes:</p>

<ul class="task-list">
<li>remember that each API request must attach a token for server-side verification</li>
<li>if the token is invalid or expired, we must force the user to login at the main page (see commented code)</li>
</ul><blockquote>
<p>Server-side code snippet</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">getprofile</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>

    <span class="c1">//object propery interface for success/error</span>
    <span class="c1">//is your contract with client-side</span>

    <span class="c1">//depends on last promise</span>
    <span class="kd">function</span> <span class="nx">returnSuccess</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">token</span> <span class="o">:</span> <span class="nx">token</span><span class="p">,</span>
                <span class="nx">data</span> <span class="o">:</span> <span class="nx">results</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//by convention, this is our error interface</span>
    <span class="kd">function</span> <span class="nx">returnError</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">msg</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//control logic</span>

    <span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">dbPool</span><span class="p">();</span>

    <span class="nx">deferJwtVerify</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">poolGetConnection</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">getAcctByID</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">releaseConnection</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">returnSuccess</span><span class="p">)</span>

<span class="p">}</span>

<span class="c1">//application logic returns success result or error messages</span>

<span class="kd">function</span> <span class="nx">deferJwtVerify</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">SECRET</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Invalid token'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">jwtPayload</span> <span class="o">=</span> <span class="nx">decoded</span><span class="p">;</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">jwtPayload</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">poolGetConnection</span><span class="p">(</span><span class="nx">jwtPayload</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">dbPool</span><span class="p">();</span>

    <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error getting database connection"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">jwtPayload</span> <span class="o">:</span> <span class="nx">jwtPayload</span><span class="p">,</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">connection</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getAcctByID</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'SELECT * FROM Acct WHERE ID = ?'</span><span class="p">;</span>

    <span class="c1">//jwtPayload.id comes from generateToken</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">jwtPayload</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//internal error, do not broadcast to user</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'System error: getAcctByID'</span><span class="p">);</span>

            <span class="c1">//this is the error message to the user</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error getting account"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
                <span class="c1">//results is an array</span>
                <span class="nx">results</span> <span class="o">:</span> <span class="nx">results</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">releaseConnection</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">results</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">results</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'No record found'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h3>Password HMAC</h3>

<p>Storing password as clear text to our database table is not recomended. So instead of using bcrypt, we will use HMAC and in particular, we are going to use jwa library. In addition, we are going to use another string called "salt" that is then appended to the user password before generating the signature. It is up to you to append the salt at the end of the user password, after the third character of the password or whatever scheme you have in mind.</p>

<p>The purpose of the salt and HMAC is to make password storage in our database table that much harder to crack since the attacker needs to know both the salt and our secret key before he can retrieve the password. Of course, you may store the salt in a separate table or encrypt it if you are that paranoid.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">jwa</span>
</pre></div>

<blockquote>
<p>Code template</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">jwa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jwa'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">jwa</span><span class="p">(</span><span class="s1">'hs256'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pswd</span> <span class="o">=</span> <span class="s1">'userPasswordHere'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="s1">'shhhhhh'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">hmac</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">pswd</span> <span class="o">+</span> <span class="nx">salt</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
<span class="nx">hmac</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">pswd</span> <span class="o">+</span> <span class="nx">salt</span><span class="p">,</span> <span class="nx">signature</span><span class="p">,</span> <span class="nx">secret</span><span class="p">)</span> <span class="c1">// === true</span>
<span class="nx">hmac</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">pswd</span><span class="p">,</span> <span class="nx">signature</span><span class="p">,</span> <span class="s1">'trickery!'</span><span class="p">)</span> <span class="c1">// === false</span>
</pre></div>

<h3>Change Password</h3>

<blockquote>
<p>Code snippet at client-side</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s1">'#btnSubmitPassword'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="s2">"new password"</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">),</span>
            <span class="s2">"retype password"</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>

        <span class="p">}).</span><span class="kd">with</span> <span class="p">(</span><span class="s1">'new password'</span><span class="p">,</span> <span class="s1">'retype password'</span><span class="p">);</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">({</span>
        <span class="s2">"new password"</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPswd1'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="s2">"retype password"</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPswd2'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">},</span> <span class="nx">schema</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//entries are valid, now check if pswd1 = pswd2</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPswd1'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPswd2'</span><span class="p">).</span><span class="nx">val</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="s1">'New password and re-typed new password are not the same'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
        <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/updpswd"</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span>
            <span class="c1">//email : $('#edtLoginEmail').val(),</span>
            <span class="nx">pswd</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPswd1'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
            <span class="nx">token</span> <span class="o">:</span> <span class="nx">token</span>
        <span class="p">},</span>
        <span class="nx">success</span> <span class="o">:</span>
        <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

                    <span class="nx">alert</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                    <span class="nx">alert</span><span class="p">(</span><span class="s1">'invalid token'</span><span class="p">)</span> <span class="c1">//force to main page</span>

                    <span class="c1">//window.open('/static/main.html',"_self");</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<blockquote>
<p>Code snippet at server-side</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">updpswd</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>

    <span class="c1">//object propery interface for success/error</span>
    <span class="c1">//is your contract with client-side</span>

    <span class="c1">//depends on last promise</span>
    <span class="kd">function</span> <span class="nx">returnSuccess</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">token</span> <span class="o">:</span> <span class="nx">token</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">msg</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//by convention, this is our error interface</span>
    <span class="kd">function</span> <span class="nx">returnError</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">msg</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//control logic</span>

    <span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">dbPool</span><span class="p">();</span>

    <span class="nx">deferJwtVerifyRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">poolGetConnectionRequest</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatePassword</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">releaseConnectionThenMsg</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">returnSuccess</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span> <span class="p">(</span><span class="nx">returnError</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferJwtVerifyRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">SECRET</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">decoded</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">'Invalid token'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">jwtPayload</span> <span class="o">=</span> <span class="nx">decoded</span><span class="p">;</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">jwtPayload</span> <span class="o">:</span> <span class="nx">jwtPayload</span><span class="p">,</span>
                <span class="nx">request</span> <span class="o">:</span> <span class="nx">request</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">poolGetConnectionRequest</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">dbPool</span><span class="p">();</span>

    <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error getting database connection"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">jwtPayload</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">jwtPayload</span><span class="p">,</span>
                <span class="nx">request</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">connection</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">updatePassword</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">pswd</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">pswd</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'UPDATE Acct SET Password = ?, Salt = ? WHERE ID = ?'</span><span class="p">;</span>

    <span class="c1">// Generate a new version4 (random) uuid salt on every password change</span>

    <span class="kd">var</span> <span class="nx">salt</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span> <span class="c1">// e.g. '110ec58a-a0f2-4ac4-8393-c866d813b8d1'</span>

    <span class="kd">var</span> <span class="nx">pswdsignature</span> <span class="o">=</span> <span class="nx">hmac</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">pswd</span> <span class="o">+</span> <span class="nx">salt</span><span class="p">,</span> <span class="nx">PSWDSECRET</span><span class="p">);</span> <span class="c1">//output is Base64 (43 characters)</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="nx">pswdsignature</span><span class="p">,</span> <span class="nx">salt</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">jwtPayload</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//internal error, do not broadcast to user</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'System error: updatePassword'</span><span class="p">);</span>

            <span class="c1">//this is the error message to the user</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error updating your password"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>

                <span class="nx">msg</span> <span class="o">:</span> <span class="s1">'Update password successful'</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">releaseConnectionThenMsg</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">when</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h3>Step control flow library</h3>

<p>Control flow libraries like Async and Step greatly help in avoiding callback hell. In this book, I find the Step library to be simpler than Async as far as the Async waterfall equivalent functionality is concerned.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">step</span>
</pre></div>

<blockquote>
<p>Code template for Step (courtesy of GitHub):</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">Step</span><span class="p">(</span>
  <span class="kd">function</span> <span class="nx">readSelf</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="kd">function</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="kd">function</span> <span class="nx">showIt</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newText</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">newText</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span>
</pre></div>

<p>The "this" keyword is used in place of the callback function you want to invoke in series. The "results" parameter is the result of the previous callback function.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Step</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"step"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
        <span class="s2">"host"</span> <span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">:</span> <span class="s2">"YourPasswordHere"</span><span class="p">,</span>
        <span class="s2">"database"</span> <span class="o">:</span> <span class="s2">"dbapp"</span>
    <span class="p">});</span>

<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">    var sql = "SELECT * FROM Acct";</span>
<span class="cm">    connection.query(sql, function (error, results) {</span>
<span class="cm">    if (error) {</span>
<span class="cm">    return console.error(error);</span>
<span class="cm">    }</span>
<span class="cm">    console.log(results);</span>
<span class="cm">    connection.release();</span>
<span class="cm">    });</span>
<span class="cm">     */</span>

    <span class="nx">Step</span><span class="p">(</span>
        <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'SELECT salt FROM Acct WHERE id = ?'</span><span class="p">;</span>

        <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">someArbitraryID</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
        <span class="kd">function</span> <span class="nx">second</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s1">'SELECT password FROM Acct WHERE id = ?'</span><span class="p">;</span>

        <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">otherArbitraryID</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
        <span class="kd">function</span> <span class="kr">final</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>

        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>Output:</p>

<div class="highlight highlight-javascript"><pre><span class="p">[</span> <span class="p">{</span> <span class="nx">salt</span><span class="o">:</span> <span class="s1">'0ef3d02b-451c-4a76-965b-5dafa53ffef6'</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">[</span> <span class="p">{</span> <span class="nx">password</span><span class="o">:</span> <span class="s1">'u6WogJvVpTfJVGrpG6kIe17dx6d8KTij1CaZkHZVOJo'</span> <span class="p">}</span> <span class="p">]</span> 
</pre></div>

<blockquote>
<p>Note: The Step control library may be useful for code that are relatively short. However, once you deal with error handling and if you deal with a long chain of business logic, it will be cumbersome to read in no time since the control logic are tightly coupled with the application logic. Which is why you need to master promise-based programming which addresses this problem in an elegant way.</p>
</blockquote>

<h3>Error Handling</h3>

<p>So far, our code is simply throwing or logging an error to console when it encounters one. However, there are two major types of error that we need to handle:</p>

<ol class="task-list">
<li>System error - all system-related errors that Node has encountered including I/O, network or storage tier</li>
<li>Application error - for example, database returns empty result when we expect one or more records</li>
</ol><h3>Breaking Code into Modules</h3>

<blockquote>
<p>Entire code of control logic (whenAppControl.js)</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Hapi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hapi'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'app'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Joi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'joi'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">Hapi</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">hello</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/getprofile'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getprofile</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/updpswd'</span><span class="p">,</span>
    <span class="nx">handler</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">updpswd</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span>
    <span class="nx">method</span> <span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">:</span> <span class="s1">'/login'</span><span class="p">,</span>
    <span class="nx">config</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">login</span><span class="p">,</span>
        <span class="nx">validate</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">payload</span> <span class="o">:</span> <span class="p">{</span>
                <span class="nx">email</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">email</span><span class="p">(),</span>
                <span class="nx">password</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/[a-zA-Z0-9!@#$%^&amp;*()]{7,20}/</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Server started at: '</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Application Logic</p>

<blockquote>
<p>The application logic is contained in a file called index.js at /root/myapp/node_modules/app</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="c1">//code snippet for index.js</span>

<span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"jsonwebtoken"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">jwa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jwa'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">jwa</span><span class="p">(</span><span class="s1">'hs256'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-uuid'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'when'</span><span class="p">);</span>

<span class="c1">//NOTE: SECRET VARIABLES ARE EXAMPLES ONLY, DO NOT USE FOR PRODUCTION</span>

<span class="c1">//secret for JSON Web Token</span>
<span class="kr">const</span> <span class="nx">SECRET</span> <span class="o">=</span> <span class="s1">'62392c30-55ce-4e57-a754-a02d2d618acd'</span><span class="p">;</span>

<span class="c1">//secret for password stored in Acct table as HMAC</span>
<span class="kr">const</span> <span class="nx">PSWDSECRET</span> <span class="o">=</span> <span class="s1">'d1982931-9db8-463f-8949-359bc70d9ad4'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">dbPool</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
        <span class="s2">"host"</span> <span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">:</span> <span class="s2">"secret"</span><span class="p">,</span>
        <span class="s2">"database"</span> <span class="o">:</span> <span class="s2">"dbapp"</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Handler in top level</span>
<span class="kd">function</span> <span class="nx">hello</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reply</span><span class="p">(</span><span class="s1">'Hello world!'</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//by convention, returns a JSON object with two properties: success and msg</span>
    <span class="kd">function</span> <span class="nx">returnSuccess</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">token</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">returnError</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reply</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="nx">success</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">msg</span> <span class="o">:</span> <span class="nx">msg</span>
            <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">//control logic</span>

    <span class="kd">var</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pswd</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>

    <span class="nx">deferPoolGetConnection</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">pswd</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">getSalt</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">checkEmailAndPswd</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">generateToken</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">returnSuccess</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span> <span class="p">(</span><span class="nx">returnError</span><span class="p">)</span> <span class="c1">//catches all errors anywhere in the chain</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">hello</span> <span class="o">:</span> <span class="nx">hello</span><span class="p">,</span>
    <span class="nx">getprofile</span> <span class="o">:</span> <span class="nx">getprofile</span><span class="p">,</span>
    <span class="nx">updpswd</span> <span class="o">:</span> <span class="nx">updpswd</span><span class="p">,</span>
    <span class="nx">login</span> <span class="o">:</span> <span class="nx">login</span>
<span class="p">};</span>
</pre></div>

<p>Module.exports is an object that gets exposed when you import or require a module. That object can have data and/or functions as its value. The exports alias is a variable that references module.exports, so as long as you just attach properties to either exports or module.exports object, you will be fine. However, when you assign a new value to either exports or module.exports, the previous attachments will be ignored just as with any variable, and whatever is the latest value of module.exports will get exported. See <a href="http://nodejs.org/docs/latest/api/modules.html">http://nodejs.org/docs/latest/api/modules.html</a>.</p>

<p>For consistency, I will only use module.exports and write it as the last code in the module using the following convention (see example above).</p>

<div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">functionName1</span><span class="o">:</span> <span class="nx">functionName1</span><span class="p">,</span>
    <span class="nx">functionName2</span><span class="o">:</span> <span class="nx">functionName2</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<h3>Posting data to database</h3>

<blockquote>
<p>Code snippet at client-side</p>
</blockquote>

<div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">"#btnSubmitProfile"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">currentYear</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
            <span class="nx">FirstName</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">LastName</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Month</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Day</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">31</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Year</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">1940</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="nx">currentYear</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">AccountNumber</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">100000000000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">999999999999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">RoutingNumber</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">100000000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">999999999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">Street</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">City</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">State</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">max</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
            <span class="nx">ZipCode</span> <span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mi">10000</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mi">99999</span><span class="p">).</span><span class="nx">required</span><span class="p">(),</span>
        <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">objData</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">FirstName</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPFirstName'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">LastName</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPLastName'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Month</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#cmbPBirthMonth'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Day</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBirthDay'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Year</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBirthYear'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">AccountNumber</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPBankAcctNumber'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">RoutingNumber</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPRoutingNumber'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">Street</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPStreetAddress'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">City</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPCity'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">State</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#cmbPState'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">ZipCode</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#edtPZipCode'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">objData</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">abortEarly</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

            <span class="c1">//attach the token</span>
            <span class="nx">objData</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">type</span> <span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
                <span class="nx">url</span> <span class="o">:</span> <span class="s2">"/app/postprofile"</span><span class="p">,</span>
                <span class="nx">data</span> <span class="o">:</span> <span class="nx">objData</span><span class="p">,</span>
                <span class="nx">success</span> <span class="o">:</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>

                    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>

                            <span class="c1">//alert(obj.msg);</span>

                            <span class="nx">alert</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' VALUES === '</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="c1">//valid token</span>

                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                            <span class="nx">alert</span><span class="p">(</span><span class="s1">'invalid token'</span><span class="p">)</span> <span class="c1">//force to main page</span>

                            <span class="c1">//window.open('/static/main.html',"_self");</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
                    <span class="p">}</span>

                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>I leave posting data to the database as an exercise to you. It is logically the same as the "Change Password" section earlier. However, node-mysql offers a convenient syntax for UPDATE command so I will give you a clue (see "Node-mysql Overview" section).</p>

<pre><code>var sql = 'UPDATE Acct SET ? WHERE ID = ?';

var post = {
    FirstName : request.payload.FirstName,
    LastName : request.payload.LastName,
    BirthMonth : request.payload.Month,
    BirthDay : request.payload.Day,
    BirthYear : request.payload.Year,
    BankAcct : request.payload.AccountNumber,
    RoutingNumber : request.payload.RoutingNumber,
    Street : request.payload.Street,
    City : request.payload.City,
    State : request.payload.State,
    ZipCode : request.payload.ZipCode
}

obj.connection.query(sql, [post, objJwtPayload.id], function (error, results) {
    ...
}
</code></pre>

<h3>Exercise</h3>

<p>Here is the SQL for FeeSchedule table. I leave coding the add and update/delete functionality in HTML page to the reader. The box on the left side of Update/Delete page from the Fee Schedule menu displays all the records below.</p>

<div class="highlight highlight-sql"><pre><span class="n">use</span> <span class="n">dbapp</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Visa'</span><span class="p">,</span> <span class="s1">'visa'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">067</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">299</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Visa'</span><span class="p">,</span> <span class="s1">'visa'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">056</span><span class="p">,</span> <span class="mi">300</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">699</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Visa'</span><span class="p">,</span> <span class="s1">'visa'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">045</span><span class="p">,</span> <span class="mi">700</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'MasterCard'</span><span class="p">,</span> <span class="s1">'mc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">070</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">299</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'MasterCard'</span><span class="p">,</span> <span class="s1">'mc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">065</span><span class="p">,</span> <span class="mi">300</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">699</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'MasterCard'</span><span class="p">,</span> <span class="s1">'mc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">054</span><span class="p">,</span> <span class="mi">700</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'American Express'</span><span class="p">,</span> <span class="s1">'amex'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">072</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">299</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'American Express'</span><span class="p">,</span> <span class="s1">'amex'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">065</span><span class="p">,</span> <span class="mi">300</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">699</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'American Express'</span><span class="p">,</span> <span class="s1">'amex'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">059</span><span class="p">,</span> <span class="mi">700</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Discover'</span><span class="p">,</span> <span class="s1">'dc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">069</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">299</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Discover'</span><span class="p">,</span> <span class="s1">'dc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">055</span><span class="p">,</span> <span class="mi">300</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">699</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">FeeSchedule</span><span class="p">(</span><span class="n">CardType</span><span class="p">,</span> <span class="k">Alias</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">,</span> <span class="n">MinAmtRange</span><span class="p">,</span> <span class="n">MaxAmtRange</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="s1">'Discover'</span><span class="p">,</span> <span class="s1">'dc'</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">049</span><span class="p">,</span> <span class="mi">700</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">999</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
</pre></div>

<h3>MySQL commands</h3>

<ul class="task-list">
<li>USE</li>
<li>SELECT</li>
<li>DELETE</li>
<li>INSERT</li>
<li>UPDATE</li>
<li>ALTER TABLE</li>
<li>TRUNCATE TABLE</li>
<li>DROP TABLE</li>
</ul><h3>Master/Detail Transaction</h3>

<p>Per our database structure (see "Database Schema" section at Part V), when we add a transaction, it will be inserted to the Transaction master table and the miscellaneous data to TransactionDetails table. Also, we need to guarantee that the transaction will be committed to these two tables, otherwise rollback the transaction (ACID constraints of RDBMS).</p>

<p>If you are wondering why we don't just store all the transaction details to one table, the reason is that a withdrawal is also a transaction, but it does not have other details like when we are adding a new card payment transaction. So to conform with relational database normalization, we are creating a child table for transaction details.</p>

<blockquote>
<p>Code template for database transaction (courtesy of node-mysql). </p>
</blockquote>

<p>Note that turning anonymous functions into separate named functions does not solve the problem of callback hell. In that case, you merely rearrange and invoke them accordingly. In short, you are just refactoring your code.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET title=?'</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="s1">'Post '</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span> <span class="o">+</span> <span class="s1">' added'</span><span class="p">;</span>

        <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO log SET data=?'</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success!'</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<h3>Promise-based Database Transaction</h3>

<p>For convenience, here is the rectified and ready-to-run transaction example from node-mysql assuming you have already run the SQL script below.</p>

<p>SQL script:</p>

<div class="highlight highlight-sql"><pre><span class="n">use</span> <span class="n">dbapp</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">posts</span><span class="o">`</span> <span class="p">(</span>
<span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="o">`</span><span class="n">Title</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">log</span><span class="o">`</span> <span class="p">(</span>
<span class="o">`</span><span class="n">ID</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="o">`</span><span class="k">Data</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">ID</span><span class="o">`</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>

<p>testTxn.js</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//testTxn.js</span>

<span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
        <span class="s2">"host"</span> <span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">:</span> <span class="s2">"YourPasswordHere"</span><span class="p">,</span>
        <span class="s2">"database"</span> <span class="o">:</span> <span class="s2">"dbapp"</span>
    <span class="p">});</span>

<span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="s1">'MySQL Transaction'</span><span class="p">;</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET title=?'</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="s1">'Post '</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span> <span class="o">+</span> <span class="s1">' added'</span><span class="p">;</span>

                <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO log SET data=?'</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                        <span class="p">});</span>
                    <span class="p">}</span>
                    <span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                                <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                            <span class="p">});</span>
                        <span class="p">}</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success!'</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>Output:</p>

<pre><code>success
</code></pre>

<p>Now we are going to produce the Promise-based version of database transaction.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">//testPromiseTxn.js</span>

<span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mysql"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">when</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"when"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">pool</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span>
        <span class="s2">"host"</span> <span class="o">:</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"user"</span> <span class="o">:</span> <span class="s2">"root"</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">:</span> <span class="s2">"YourPasswordHere"</span><span class="p">,</span>
        <span class="s2">"database"</span> <span class="o">:</span> <span class="s2">"dbapp"</span>
    <span class="p">});</span>


<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferPoolGetConnection</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error getting database connection"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">connection</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferBeginTxn</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">beginTransaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error on beginTransaction"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
                <span class="nx">title</span> <span class="o">:</span> <span class="s1">'Promise-based MySQL Transaction'</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferInsertPosts</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO posts SET title=?'</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error on insert posts"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
                <span class="nx">log</span> <span class="o">:</span> <span class="s1">'Post '</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span> <span class="o">+</span> <span class="s1">' added'</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferInsertLog</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'INSERT INTO log SET data=?'</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error on insert posts"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
                <span class="nx">connection</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">deferCommitTxn</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">when</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">commit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">rollback</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{});</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s2">"System error on commit Transaction"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success'</span><span class="p">);</span>
            <span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">deferPoolGetConnection</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferBeginTxn</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferInsertPosts</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferInsertLog</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deferCommitTxn</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span> <span class="p">(</span><span class="nx">onError</span><span class="p">);</span>
</pre></div>

<p>Output:</p>

<pre><code>success
</code></pre>

<p>Compare our promise-based code (five lines of control logic plus one for error) with the callback version which has five nested callbacks all in all. This is not about code length but about code clarity. The resolve method can accept any data (primitive types, object or array) that will serve as input to subsequent function (which is actually a function that returns a promise object). Notice how the result.insertId method can be used to retrieve the ID for a related table or child table for master/detail relationships?  </p>

<h3>Package.json</h3>

<p>Package.json is provided in this book for your convenience (see Packages Used in this same Part VI). However, if you want to clone your deployment server, you may use a configuration management tool (like Ansible). Automated deployment is beyond the scope of this book.</p>

<h3>More exercises</h3>

<p>I have left ample room for you to test your understanding and tweak our sample app to populate the Transaction and TransactionDetails tables, withdraw to bank account or compute the running balance on every transaction based on fee schedule. But I assume you may not be interested. After all, you are reading this book because you want to jumpstart developing your real application.</p>

<h2>Part VII. Deployment</h2>

<h3>Deployment Options</h3>

<ul class="task-list">
<li>Physical machine - bare metal servers</li>
<li>Virtual machine - on-premise or public cloud</li>
</ul><blockquote>
<p>Note: Cloud computing is just a marketing term for virtualization services that are exposed via HTTP or SOAP interfaces whether it is on-premise (private cloud like Eucalyptus, OpenStack, Proxmox, etc) or public cloud (Infrastructure as a Service like Amazon Web Services or Platform as a Service like Heroku)</p>
</blockquote>

<h3>Scale Out vs Scale Up</h3>

<p>My rules of thumb:</p>

<p>For logic tier, scale out (horizontal scaling) means your Web applications (be it on virtual or physical machines) may go down anytime without affecting your overall business. Scaling out means  you are deploying identical Web applications to commodity servers (N-tier architecture) for scalability and availability</p>

<p>For storage tier, scale up (vertical scaling) means you use more powerful commodity servers (compared to those at the logic tier) for your relational/non-relational databases or distributed storage systems like Ceph. Typically, these are used as dedicated servers for RDBMS (meaning they don't host other software besides itself). Unlike the logic tier, the storage tier requires deeper knowledge of operations in computing, storage and networking aspects of a system</p>

<h3>From Development to Production</h3>

<p>To paraphrase Albert Einstein,</p>

<blockquote>
<p>In theory, development and production environments are the same. In practice, they are not.</p>
</blockquote>

<p>Why?</p>

<p>To quote <a href="http://www.iheavy.com/2012/06/21/4-letter-word-dividing-dev-and-ops/">Sean Hull</a>,</p>

<p>Developers are tasked with features and delivering business solutions. Operations teams are tasked with stability and uptime. That means working against change, limiting or slowing it down where possible.</p>

<p>Dev2ops.org calls it the <a href="http://dev2ops.org/2010/02/what-is-devops/">Wall of Confusion</a>.</p>

<p><a href="https://camo.githubusercontent.com/04e89d73e8f3cfd29c7e6eb44b012cd466d61d27/687474703a2f2f692e696d6775722e636f6d2f54674d316931682e706e67" target="_blank"><img src="https://camo.githubusercontent.com/04e89d73e8f3cfd29c7e6eb44b012cd466d61d27/687474703a2f2f692e696d6775722e636f6d2f54674d316931682e706e67" alt="" data-canonical-src="http://i.imgur.com/TgM1i1h.png" style="max-width:100%;"></a></p>

<p>Using a Three Tier Architecture for building Web applications, we can address separation of concerns between development and production.</p>

<p><a href="https://camo.githubusercontent.com/e6806d6a408841c36a6f8f8c63f0c57018c883db/687474703a2f2f692e696d6775722e636f6d2f6562395339467a2e6a7067" target="_blank"><img src="https://camo.githubusercontent.com/e6806d6a408841c36a6f8f8c63f0c57018c883db/687474703a2f2f692e696d6775722e636f6d2f6562395339467a2e6a7067" alt="" data-canonical-src="http://i.imgur.com/eb9S9Fz.jpg" style="max-width:100%;"></a></p>

<p>For presentation tier, we can use Single Page Applications.</p>

<p>For logic tier, we can expose our server-side application as RESTful API.</p>

<p>For storage tier, we can use relational databases or NoSQL software.</p>

<p>The presentation tier communicates with the logic tier using JSON. The logic tier, in turn, translates JSON data to appropriate data format of the underlying storage software.</p>

<p>In practice, it is more complex than that.</p>

<p>That is why there is the <a href="http://12factor.net/">Twelve Factor App</a> that outlines minimizing divergence between development and production.</p>

<h3>Deployment Architecture</h3>

<ul class="task-list">
<li>two-tier architecture - HTML is presentation tier, database and Web application are combined as the server</li>
<li>three-tier architecture - HTML is presentation tier, RESTful API as logic tier, database as storage tier</li>
<li>N-tier architecture - the same as three-tier architecture. The difference lies in N-number of physical nodes in the logic tier, each node containing identical Web application</li>
</ul><h3>Configuration Management</h3>

<p>One aspect of configuration management is to keep your development and production environments in sync. For simple setup like two- or three-tier architecture, you may use manual scripting, control panel from your favorite provider, FTP, SSH and the like.</p>

<p>For Turnkey Linux, you can simply use the included Webmin and Web Shell.</p>

<p>However, for N-tier architecture, configuration management tools like Ansible or Salt Stack may come in handy in contrast with their more complex brethren like Chef and Puppet.</p>

<p>In this book, since we are using Turnkey Linux, there is more to Webmin and Web Shell. It is called <a href="http://www.turnkeylinux.org/docs/tklbam">TKLBAM</a> (Turnkey Linux Backup and Migration).</p>

<h3>TKLBAM</h3>

<p>When we talk of backups, we are concerned with two main types of storage.</p>

<ul class="task-list">
<li>File storage</li>
<li><a href="http://en.wikipedia.org/wiki/Block_(data_storage)">Block storage</a></li>
</ul><p>TKLBAM is capable of backing up both types of storage.</p>

<blockquote>
<p>Note: I will limit discussing TKLBAM in the context of logic tier only. Using TKLBAM in storage tier entails more complex issues that are beyond the scope of this book.</p>
</blockquote>

<p>As illustrated in the DevOps dilemma, we are concerned with making sure that our development and production environments are identical as much as possible. For simple deployment architectures up to a couple of servers using N-tier architecture, TKLBAM fits the bill.</p>

<p>Let me explain.</p>

<p>In this book, I am using VirtualBox to run a Turnkey Linux virtual machine. All of the JavaScript code can be written using your desktop or laptop which is then uploaded to our TKL VM. Since we are using Node.js, we have a Node background process that looks for changes in files uploaded and compile it accordingly. You can then test the server code from your Web browser. You go over this process again and again until you are done with Web application testing.</p>

<p>Once you are done with all the settings of your virtual machine, you may start backing it up or in other words, make a copy of your virtual machine such that it can be recreated as identical target machine suitable for deployment.</p>

<h3>From VirtualBox to AWS</h3>

<p>If you are using Amazon Web Services (AWS), TKLBAM is the fastest route from VirtualBox to AWS.</p>

<p>Requirements for TKLBAM</p>

<ul class="task-list">
<li>
<a href="http://aws.amazon.com/">AWS</a> account</li>
<li>
<a href="https://hub.turnkeylinux.org/">Turnkey Hub</a> account - an API key will be provided to link your TKL VM to AWS</li>
<li>Link API key to TKLBAM - via Webmin or command line <code>tklbam-init API-KEY</code>
</li>
</ul><p><a href="https://camo.githubusercontent.com/598b173247fb4d8a06018d418ea929e4779d198e/687474703a2f2f692e696d6775722e636f6d2f6b4c777a34506a2e706e67" target="_blank"><img src="https://camo.githubusercontent.com/598b173247fb4d8a06018d418ea929e4779d198e/687474703a2f2f692e696d6775722e636f6d2f6b4c777a34506a2e706e67" alt="" data-canonical-src="http://i.imgur.com/kLwz4Pj.png" style="max-width:100%;"></a></p>

<p><a href="https://camo.githubusercontent.com/f97b6ec9231b26cdfbe8414e1a8b22632b1dbc56/687474703a2f2f692e696d6775722e636f6d2f473737646b35392e706e67" target="_blank"><img src="https://camo.githubusercontent.com/f97b6ec9231b26cdfbe8414e1a8b22632b1dbc56/687474703a2f2f692e696d6775722e636f6d2f473737646b35392e706e67" alt="" data-canonical-src="http://i.imgur.com/G77dk59.png" style="max-width:100%;"></a></p>

<h3>Backup VM using TKLBAM</h3>

<p>When you backup your virtual machine, there are two options:</p>

<ul class="task-list">
<li>using the command line or </li>
<li>via the Webmin module</li>
</ul><p>Upon backup, a base profile will be downloaded from your Turnkey Hub account that determines the initial state of your VM. Using the Python-based Duplicity open source software, TKLBAM interfaces with Amazon S3 where it uploads your backup to the nearest AWS data center based on your GeoIP location.</p>

<p>With the command line (<code>tklbam backup</code>), the end of the output is something like this:</p>

<pre><code>--------------[ Backup Statistics ]--------------
StartTime 1410597895.78 (Sat Sep 13 08:44:55 2014)
EndTime 1410598141.64 (Sat Sep 13 08:49:01 2014)
ElapsedTime 245.86 (4 minutes 5.86 seconds)
SourceFiles 4334
SourceFileSize 37701057 (36.0 MB)
NewFiles 4334
NewFileSize 37701057 (36.0 MB)
DeletedFiles 0
ChangedFiles 0
ChangedFileSize 0 (0 bytes)
ChangedDeltaSize 0 (0 bytes)
DeltaEntries 4334
RawDeltaSize 34485594 (32.9 MB)
TotalDestinationSizeChange 12816803 (12.2 MB)
Errors 0 
</code></pre>

<p>Now, when you login to your Turnkey Hub, you will see the backups dashboard.</p>

<p><a href="https://camo.githubusercontent.com/92bfee679eda55edf0adcce45da3ddf60b14fbbf/687474703a2f2f692e696d6775722e636f6d2f4e68754b4336572e706e67" target="_blank"><img src="https://camo.githubusercontent.com/92bfee679eda55edf0adcce45da3ddf60b14fbbf/687474703a2f2f692e696d6775722e636f6d2f4e68754b4336572e706e67" alt="" data-canonical-src="http://i.imgur.com/NhuKC6W.png" style="max-width:100%;"></a></p>

<p>In this book, a Turnkey Linux Node VM has no MySQL installed. Installing MySQL and all required Node packages uploads a mere 33 MB of backup data to S3.</p>

<h3>Restore backup to AWS</h3>

<p>Here is the fun part: you can login to your Turnkey Hub account to restore or launch that backup to a new AWS cloud server (EC2). Afterwards, all you need to do is simply associate your domain name to your AWS cloud server. Everything from the EC2 settings to security group have been taken care of transparently. When you start your new EC2 instance, it installs the security updates automatically.</p>

<p><a href="https://camo.githubusercontent.com/2d194ba476d0d56457db474a54a5048eadcc9ef1/687474703a2f2f692e696d6775722e636f6d2f626f39726b32732e706e67" target="_blank"><img src="https://camo.githubusercontent.com/2d194ba476d0d56457db474a54a5048eadcc9ef1/687474703a2f2f692e696d6775722e636f6d2f626f39726b32732e706e67" alt="" data-canonical-src="http://i.imgur.com/bo9rk2s.png" style="max-width:100%;"></a></p>

<p><a href="https://camo.githubusercontent.com/0d8202889ce34e5738bc02e298d733569bc8b528/687474703a2f2f692e696d6775722e636f6d2f653978515836562e706e67" target="_blank"><img src="https://camo.githubusercontent.com/0d8202889ce34e5738bc02e298d733569bc8b528/687474703a2f2f692e696d6775722e636f6d2f653978515836562e706e67" alt="" data-canonical-src="http://i.imgur.com/e9xQX6V.png" style="max-width:100%;"></a></p>

<p>(Newly launched EC2 server)</p>

<h3>Turnkey Linux Pricing</h3>

<p>Using Turnkey Linux on Amazon Web Services has associated fees but on your premises, it is free.</p>

<p><strong>EC2 server usage fees</strong></p>

<p>Starting at $0.02/hour ($14/month) for a cloud server with 613 MB RAM</p>

<p><strong>S3 backup storage fee</strong></p>

<p>Only $0.15/GB per month for ultra-durable cloud storage</p>

<p>More info at <a href="https://hub.turnkeylinux.org/pricing">https://hub.turnkeylinux.org/pricing</a>.</p>

<h3>A Word on Backup and Restore</h3>

<p>For development, with VirtualBox you can backup your virtual machine as a clone or export it as an OVA file.</p>

<p>For production environments on premise, you may use your favorite platform's facility for backup and restore. For example, OpenStack and Proxmox each has their own means of backing up and restoring your virtual machine.</p>

<p>For AWS, there is TKLBAM.</p>

<p>As I mentioned earlier, backing up the storage tier like MySQL is more complex than just file backup with TKLBAM. In fact, it covers a whole chapter in the O'Reilly book "High Performance MySQL", Third Edition.</p>

<h2>Epilogue</h2>

<p>The traditional way of coding with Node is by using continuation-passing style. However, it leads to callback hell. Here is a quote from <a href="http://sealedabstract.com/code/broken-promises/">Mikeal Rogers</a>:</p>

<blockquote>
<p>And when we do hit these problems like callback hell, I’ll tell you a secret: there’s also a coroutine hell and a monad hell and a hell for any abstraction you create if you use it enough.</p>
</blockquote>

<p>Drew Crawford even goes on to say that there is also promise hell.</p>

<p>So what the hell is the problem?</p>

<blockquote>
<p>The fundamental problem is how to separate control logic from application logic.</p>
</blockquote>

<p>Tools like functional programming, promise-based programming, event-driven programming and functional reactive programming all enable you to separate control logic from application logic. Although the core of Node.js uses the imperative programming of callbacks, it gets by through the intensive use of declarative programming with EventEmitter.  </p>

<p>So does it mean you have to abandon using promises or your favorite control flow library?</p>

<p>Of course, not!</p>

<p>Experiment with control flow libraries like async, Step and others. Experiment with promises. Experiment with callbacks.  Experiment with what you see as natural and intuitive. Heck, you can even combine control flow and promises with streamline.js library. Benchmark your setup. Do not let others fool you into believing there is a silver bullet.</p>

<p>Once you know the merits and <a href="http://en.wikipedia.org/wiki/Falsifiability">falsifiable</a> downsides of all approaches, it all boils down to how adept you are using the tool.</p>

<p>As the saying goes,</p>

<blockquote>
<p>A poor man blames his tools.</p>
</blockquote>

<p>However, in some cases, there are tools that are leaky abstractions. Here, you don't blame the poor workman. You blame the tool itself.</p>

<p>Avoid tools like the following:</p>

<ul class="task-list">
<li>MVC instead of thinking in terms of Three Tier Architecture</li>
<li>ORM instead of SQL</li>
<li>
<a href="http://harmful.cat-v.org/software/OO_programming/why_oo_sucks">class-based OOP</a> instead of functional programming</li>
</ul><p>In short, </p>

<ul class="task-list">
<li>Use the right tool for the job.</li>
<li>Avoid leaky abstractions.</li>
</ul><p>But wait, there's more.</p>

<p>To quote <a href="http://www.futurealoof.com/posts/broken-promises.html">Mikeal Rogers</a>:</p>

<blockquote>
<p>Node's success has as much to do with what Ryan and Isaac have been smart enough to leave out than what they put in.</p>
</blockquote>

<p>We owe to Ryan Dahl and Isaac Schlueter the concept of operational definition as to how we program in Node. For example, there is one standard way of writing code in Node: through callbacks using the function(err, result) signature. Second, there is the simple module.exports interface and awesome Node Package Manager. Third, they made the Node kernel as small as possible. </p>

<p>These three developments among others are the key decisions to success of Node.</p>
</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
